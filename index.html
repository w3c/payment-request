<!DOCTYPE html>
<html>
  <head>
    <title>
      Payment Request API
    </title>
    <meta charset='utf-8'>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' class=
    'remove'></script>
    <script class='remove'>
    var respecConfig = {
      github: "https://github.com/w3c/payment-request/",
      specStatus: "ED",
      editors: [{
        name: "Adrian Bateman",
        company: "Microsoft Corporation",
        w3cid: 42763,
      }, {
        name: "Zach Koch",
        company: "Google",
        w3cid: 76588,
      }, {
        name: "Roy McElmurry",
        company: "Facebook",
        w3cid: 88345,
      }, {
        name: "Domenic Denicola",
        company: "Google",
        w3cid: 52873,
      }, {
        name: "Marcos CÃ¡ceres",
        company: "Mozilla",
        w3cid: 39125,
      }],
      crEnd: "2017-10-31",
      license: "w3c-software-doc",
      previousMaturity: "WD",
      previousPublishDate: "2016-07-05",
      wg: "Web Payments Working Group",
      wgURI: "https://www.w3.org/Payments/WG/",
      wgPatentURI: "https://www.w3.org/2004/01/pp-impl/83744/status",
      testSuiteURI: "https://w3c-test.org/payment-request/",
      implementationReportURI: "https://w3c.github.io/payment-request/reports/implementation.html",
      otherLinks: [{
        key: "Can I use this API?",
        data: [{
          value: "caniuse.com",
          href: "http://caniuse.com/#feat=payment-request",
        }],
      },]
    };
    </script>
    <style>
    dt { margin-top: 0.75em; }
    table { margin-top: 0.75em; border-collapse:collapse; border-style:hidden hidden none hidden }
    table thead { border-bottom:solid }
    table tbody th:first-child { border-left:solid }
    table td, table th { border-left:solid; border-right:solid; border-bottom:solid thin; vertical-align:top; padding:0.2em }
    li { margin-top: 0.5em; margin-bottom: 0.5em;}
    </style>
  </head>
  <body>
    <section id='abstract'>
      <p>
        This specification standardizes an API to allow merchants (i.e. web
        sites selling physical or digital goods) to utilize one or more payment
        methods with minimal integration. User agents (e.g., browsers)
        facilitate the payment flow between merchant and user.
      </p>
    </section>
    <section id='sotd'>
      <p>
        The working group maintains <a href=
        "https://github.com/w3c/payment-request/issues?utf8=%E2%9C%93&amp;q=is%3Aopen%20is%3Aissue%20-label%3A%22Priority%3A%20Postponed%22%20">
        a list of all bug reports that the group has not yet addressed</a>.
        Pull requests with proposed specification text for outstanding issues
        are strongly encouraged.
      </p>
      <p>
        The deadline for comments for Candidate Recommendation is 31 October
        2017.
      </p>
      <div class="note" title="Sending comments on this document">
        <p>
          If you wish to make comments regarding this document, please raise
          them as <a href=
          "https://github.com/w3c/payment-request/issues">GitHub issues</a>.
          Only send comments by email if you are unable to raise issues on
          GitHub (see links below). All comments are welcome.
        </p>
      </div>
      <p>
        The working group will demonstrate implementation experience by
        creating a <a href=
        "https://github.com/w3c/web-platform-tests/tree/master/payment-request">
        test suite</a> and having at least two independent implementations pass
        each mandatory test (i.e., each test the corresponds to a MUST
        requirement of the specification). The working group hopes to
        demonstrate, in the form of an implementation report, interoperability
        from two or more vendors on both mobile and desktop web browsers.
      </p>
      <p>
        There has been no change in dependencies on other workings groups
        during the development of this specification.
      </p>
      <section id="at-risk">
        <h2>
          Features at risk
        </h2>
        <p>
          As this specification enters the Candidate Recommendation phase of
          the W3C standardization process, the working group has identified the
          following feature(s) as being "<dfn>at risk</dfn>" of being removed
          from the specification. The working group seeks input from
          implementers, developers, and the general public on whether these
          features should remain in the specification. If no compelling use
          cases are received, or if there is limited interest from
          implementers, these features will be removed from the specification
          before proceeding along the W3C Recommendation track.
        </p>
        <ul>
          <li>
            <a data-lt=
            "PaymentCurrencyAmount.currencySystem">currencySystem</a> (see
            <a href="https://github.com/w3c/payment-request/issues/490">issue
            490</a>).
          </li>
        </ul>
      </section>
    </section>
    <section class='informative'>
      <h2>
        Introduction
      </h2>
      <p>
        This specification describes an API that allows <a>user agents</a>
        (e.g., browsers) to act as an intermediary between three parties in a
        transaction:
      </p>
      <ul>
        <li>the payee: the merchant that runs an online store, or other party
        that requests to be paid.
        </li>
        <li>the payer: the party that makes a purchase at that online store,
        and who authenticates and authorizes payment as required.
        </li>
        <li>the <dfn data-lt="payment methods">payment method</dfn> provider:
        the party that provides the means (e.g., credit card) that the payer
        uses to pay, and that is accepted by the payee.
        </li>
      </ul>
      <p>
        The details of how to fulfill a payment request for a given <a>payment
        method</a> are handled by <dfn data-lt="payment handler">payment
        handlers</dfn>. In this specification, these details are left up to the
        <a>user agent</a>, but future specifications may expand on the
        processing model in more detail.
      </p>
      <p>
        This API also enables web sites to take advantage of more secure
        payment schemes (e.g., tokenization and system-level authentication)
        that are not possible with standard JavaScript libraries. This has the
        potential to reduce liability for the merchant and helps protect
        sensitive user information.
      </p>
      <section id="goals">
        <h2>
          Goals
        </h2>
        <ul>
          <li>Allow the user agent to act as intermediary between merchants,
          users, and <a>payment method</a> providers.
          </li>
          <li>Enable user agents to streamline the user's payment experience by
          taking into account user preferences, merchant information, security
          considerations, and other factors.
          </li>
          <li>Standardize (to the extent that it makes sense) the communication
          flow between a merchant, user agent, and <a>payment method</a>
          provider.
          </li>
          <li>Enable <a>payment method</a> providers to bring more secure
          payment transactions to the web.
          </li>
        </ul>
        <section id="out-of-scope">
          <h2>
            Out of scope
          </h2>
          <ul>
            <li>Create a new <a>payment method</a>
            </li>
            <li>Integrate directly with payment processors
            </li>
          </ul>
        </section>
      </section>
    </section>
    <section class="informative">
      <h2>
        Examples of usage
      </h2>
      <p>
        In order to use the API, the developer needs to provide and keep track
        of a number of key pieces of information. These bits of information are
        passed to the <a>PaymentRequest</a> constructor as arguments, and
        subsequently used to update the payment request being displayed to the
        user. Namely, these bits of information are:
      </p>
      <ul>
        <li>The <var>methodData</var>: A sequence of <a>PaymentMethodData</a>s
        that represents the <a>payment methods</a> that the site supports
        (e.g., "we support card-based payments, but only Visa and MasterCard
        credit cards.").
        </li>
        <li>The <var>details</var>: The details of the transaction, as a
        <a>PaymentDetailsInit</a> dictionary. This includes total cost, and
        optionally a list of goods or services being purchased, for physical
        goods, and shipping options. Additionally, it can optionally include
        "modifiers" to how payments are made. For example, "if you pay with a
        credit card of type X, it incurs a US$3.00 processing fee".
        </li>
        <li>The <var>options</var>: Optionally, a list of things as
        <a>PaymentOptions</a> that the site needs to deliver the good or
        service (e.g., for physical goods, the merchant will typically need an
        physical address to ship to. For digital goods, an email will usually
        suffice).
        </li>
      </ul>
      <p data-link-for="PaymentRequest">
        Once a <a>PaymentRequest</a> is constructed, it's presented to the end
        user via the <a>show()</a> method. The <a>show()</a> returns a promise
        that, once the user confirms request for payment, results in a
        <a>PaymentResponse</a>.
      </p>
      <section>
        <h3>
          The <code>methodData</code> argument
        </h3>
        <p>
          The <var>methodData</var> sequence contains <a>PaymentMethodData</a>
          dictionaries containing the <a>payment method identifiers</a> for the
          <a>payment methods</a> that the web site accepts and any associated
          <a>payment method</a> specific data.
        </p>
        <pre class="example js" title="The `methodData` argument">
          const methodData = [
            {
              supportedMethods: "basic-card",
              data: {
                supportedNetworks: ["visa", "mastercard"],
                supportedTypes: ["debit", "credit"],
              },
            },
            {
              supportedMethods: "https://example.com/bobpay",
              data: {
                merchantIdentifier: "XXXX",
                bobPaySpecificField: true,
              },
            },
          ];
        </pre>
      </section>
      <section>
        <h3>
          The <code>details</code> argument
        </h3>
        <p>
          The <var>details</var> contains information about the transaction
          that the user is being asked to complete, such as the line items in
          an order.
        </p>
        <pre class="example js" title="The `details` argument">
          const details = {
            id: "super-store-order-123-12312",
            displayItems: [
              {
                label: "Sub-total",
                amount: { currency: "USD", value: "55.00" },
              },
              {
                label: "Sales Tax",
                amount: { currency: "USD", value: "5.00" },
              },
            ],
            total: {
              label: "Total due",
              amount: { currency: "USD", value: "65.00" },
            },
          };
        </pre>
        <section>
          <h4>
            Shipping options
          </h4>
          <p>
            Here we see an example of how to add two shipping options to the
            <var>details</var>.
          </p>
          <pre class="example js" title="Adding shipping options">
            const shippingOptions = [
              {
                id: "standard",
                label: "ðŸš› Ground Shipping (2 days)",
                amount: { currency: "USD", value: "5.00" },
                selected: true,
              },
              {
                id: "drone",
                label: "ðŸš€ Drone Express (2 hours)",
                amount: { currency: "USD", value: "25.00" }
              },
            ];
            Object.assign(details, { shippingOptions });
          </pre>
        </section>
        <section>
          <h4>
            Conditional modifications to payment request
          </h4>
          <p>
            Here we see how to add a processing fee for using a credit card.
            Notice that it requires recalculating the total.
          </p>
          <pre class="example js" title=
          "Modifying payment request based on card type">
          // Credit card incurs a $3.00 processing fee.
          const creditCardFee = {
            label: "Credit card processing fee",
            amount: { currency: "USD", value: "3.00" },
          };

          // Modifiers apply when the user chooses to pay with
          // a credit card.
          const modifiers = [
            {
              additionalDisplayItems: [creditCardFee],
              supportedMethods: "basic-card",
              total: {
                label: "Total due",
                amount: { currency: "USD", value: "68.00" },
              },
              data: {
                supportedTypes: "credit",
              },
            },
          ];
          Object.assign(details, { modifiers });
          </pre>
        </section>
      </section>
      <section>
        <h3>
          The <code>options</code> argument
        </h3>
        <p>
          The <var>options</var> dictionary contains information the developer
          needs from the user to perform the payment (e.g., the payer's name
          and shipping address).
        </p>
        <pre class="example" title="The `options` argument">
          const options = {
            requestPayerEmail: false,
            requestPayerName: true,
            requestPayerPhone: false,
            requestShipping: true,
          }
        </pre>
      </section>
      <section>
        <h3>
          Constructing a <code>PaymentRequest</code>
        </h3>
        <p>
          Having gathered all the prerequisite bits of information, we can now
          construct a <a>PaymentRequest</a> and request that the browser
          present it to the user:
        </p>
        <pre class="example" title="Constructing a `PaymentRequest`">
          async function doPaymentRequest() {
            try {
              const request = new PaymentRequest(methodData, details, options);
              // See below for a detailed example of handling these events
              request.onshippingaddresschange = ev =&gt; ev.updateWith(details);
              request.onshippingoptionchange = ev =&gt; ev.updateWith(details);
              const response = await request.show();
              await validateResponse(response);
            } catch (err) {
              // AbortError, SecurityError
              console.error(err);
            }
          }
          async function validateResponse(response) {
            try {
              if (await checkAllValuesAreGood(response)) {
                await response.complete("success");
              } else {
                await response.complete("fail");
              }
            } catch (err) {
              // Something went wrong...
              await response.complete("fail");
            }
          }
          doPaymentRequest();
        </pre>
      </section>
      <section>
        <h3>
          Handling events and updating the payment request
        </h3>
        <p>
          Prior to the user accepting to make payment, the site is given an
          opportunity to update the payment request in response to user input.
          This can include, for example, providing additional shipping options
          (or modifying their cost), removing items that cannot ship to a
          particular address, etc.
        </p>
        <pre class="example" title="Registering event handlers">
          const request = new PaymentRequest(methodData, details, options);
          // Async update to details
          request.onshippingaddresschange = ev =&gt; {
            ev.updateWith(checkShipping(request));
          };
          // Sync update to the total
          request.onshippingoptionchange = ev =&gt; {
            const shippingOption = shippingOptions.find(
              option =&gt; option.id === request.id
            );
            const newTotal = {
              currency: "USD",
              label: "Total due",
              value: calculateNewTotal(shippingOption),
            };
            ev.updateWith({ ...details, total: newTotal });
          };
          async function checkShipping(request) {
            try {
              const json = request.shippingAddress.toJSON();

              await ensureCanShipTo(json);
              const { shippingOptions, total } = await calculateShipping(json);

              return { ...details, shippingOptions, total };
            } catch (err) {
              return { ...details, error: `Sorry! we can't ship to your address.` };
            }
          }
        </pre>
      </section>
      <section data-link-for="PaymentResponse">
        <h3>
          POSTing payment response back to a server
        </h3>
        <p>
          It's expected that data in a <a>PaymentResponse</a> will be POSTed
          back to a server for processing. To make this as easy as possible,
          <a>PaymentResponse</a> provides a <a>toJSON()</a> method that
          serializes the object directly into JSON. This makes it trivial to
          POST the resulting JSON back to a server using the <a data-cite=
          "fetch">Fetch API</a>:
        </p>
        <pre class="example" title="POSTing with `fetch()`">
          async function doPaymentRequest() {
            const payRequest = new PaymentRequest(methodData, details, options);
            const payResponse = await payRequest.show();
            let result = "";
            try {
              const httpResponse = await fetch("/process-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: payResponse.toJSON(),
              });
              result = httpResponse.ok ? "success" : "fail";
            } catch (err) {
              console.error(err);
              result = "fail";
            }
            await payResponse.complete(result);
          }
          doPaymentRequest();
        </pre>
      </section>
    </section>
    <section data-dfn-for="PaymentRequest" data-link-for="PaymentRequest">
      <h2>
        <dfn>PaymentRequest</dfn> interface
      </h2>
      <pre class="idl">
        [Constructor(sequence&lt;PaymentMethodData&gt; methodData, PaymentDetailsInit details, optional PaymentOptions options),
        SecureContext]
        interface PaymentRequest : EventTarget {
          Promise&lt;PaymentResponse&gt; show();
          Promise&lt;void&gt; abort();
          Promise&lt;boolean&gt; canMakePayment();

          readonly attribute DOMString id;
          readonly attribute PaymentAddress? shippingAddress;
          readonly attribute DOMString? shippingOption;
          readonly attribute PaymentShippingType? shippingType;

          attribute EventHandler onshippingaddresschange;

          attribute EventHandler onshippingoptionchange;
        };
      </pre>
      <div class="note">
        <p>
          A developer creates a <a>PaymentRequest</a> to make a payment
          request. This is typically associated with the user initiating a
          payment process (e.g., by activating a "Buy," "Purchase," or
          "Checkout" button on a web site, selecting a "Power Up" in an
          interactive game, or paying at a kiosk in a parking structure). The
          <a>PaymentRequest</a> allows developers to exchange information with
          the <a>user agent</a> while the user is providing input (up to the
          point of user approval or denial of the payment request).
        </p>
        <p data-link-for="PaymentRequest">
          The <a>shippingAddress</a>, <a>shippingOption</a>, and
          <a>shippingType</a> attributes are populated during processing if the
          <a data-lt="PaymentOptions.requestShipping">requestShipping</a>
          member is set.
        </p>
      </div>
      <p data-link-for="PaymentRequest">
        Because the simultaneous display of multiple <a>PaymentRequest</a> user
        interfaces might confuse the user, this specification limits the
        <a>user agent</a> to displaying one at a time via the <a>show()</a>
        method. This is ensured by a <dfn>payment request is showing</dfn>
        boolean.
      </p>
      <section>
        <h2>
          Constructor
        </h2>
        <p>
          The <a>PaymentRequest</a> is constructed using the supplied
          <var>methodData</var> list including any <a>payment method</a>
          specific <a data-lt="PaymentMethodData.data">data</a>, the payment
          <var>details</var>, and the payment <var>options</var>.
        </p>
        <p data-tests="payment-request-constructor.https.html">
          The <code><dfn data-lt=
          "PaymentRequest.PaymentRequest()">PaymentRequest(<var>methodData</var>,
          <var>details</var>, <var>options</var>)</dfn></code> constructor MUST
          act as follows:
        </p>
        <ol data-link-for="PaymentDetailsBase" class="algorithm">
          <li data-tests="payment-allowed-by-feature-policy.https.sub.html">If
          the <a>current settings object</a>'s <a data-cite=
          "!HTML#responsible-document">responsible document</a> is not
          <a>allowed to use</a> the feature indicated by attribute name
          <a>allowpaymentrequest</a>, then <a>throw</a> a
          "<a>SecurityError</a>" <a>DOMException</a>.
          </li>
          <li>Let <var>serializedMethodData</var> be an empty list.
          </li>
          <li>Establish the request's id:
            <ol>
              <li>If <var>details</var>.<a data-lt=
              "PaymentDetailsInit.id">id</a> is missing, add an <a data-lt=
              "PaymentDetailsInit.id">id</a> member to <var>details</var> and
              set its value to string that uniquely identifies this payment
              request. It is RECOMMENDED that the string be a <abbr title=
              "Universally Unique Identifier">UUID</abbr> [[!RFC4122]].
              </li>
            </ol>
          </li>
          <li>Process payment methods:
            <ol data-link-for="PaymentMethodData">
              <li>If the length of the <var>methodData</var> sequence is zero,
              then <a>throw</a> a <a>TypeError</a>, optionally informing the
              developer that at least one <a>payment method</a> is required.
              </li>
              <li>For each <var>paymentMethod</var> of <var>methodData</var>:
                <ol>
                  <li data-tests=
                  "payment-request-ctor-pmi-handling.https.html">Run the steps
                  to <a data-cite=
                  "payment-method-id#dfn-validate-a-payment-method-identifier">
                    validate a payment method identifier</a> with
                    <var>paymentMethod</var>.<a data-lt=
                    "PaymentMethodData.supportedMethods">supportedMethods</a>.
                    If it returns false, then throw a <a>RangeError</a>
                    exception and terminate this algorithm. Optionally, inform
                    the developer that the payment method identifier is
                    invalid.
                  </li>
                  <li>If the <a data-lt="PaymentMethodData.data">data</a>
                  member of <var>paymentMethod</var> is missing, let
                  <var>serializedData</var> be null. Otherwise, let
                  <var>serializedData</var> be the result of
                  <a>JSON-serializing</a>
                    <var>paymentMethod</var>.<a data-lt="PaymentMethodData.data">data</a>
                    into a string. Rethrow any exceptions.
                  </li>
                  <li>Add the tuple (<var>paymentMethod</var>.<a data-lt=
                  "PaymentMethodData.supportedMethods">supportedMethods</a>,
                  <var>serializedData</var>) to
                  <var>serializedMethodData</var>.
                  </li>
                </ol>
              </li>
            </ol>
          </li>
          <li data-link-for="PaymentDetailsInit">Process the total:
            <ol>
              <li data-tests=
              "payment-request-ctor-currency-code-checks.https.html">
                <a>Check and canonicalize total</a>
                <var>details</var>.<a>total</a>.<a data-lt=
                "PaymentItem.amount">amount</a>. Rethrow any exceptions.
              </li>
            </ol>
          </li>
          <li>If the <a>displayItems</a> member of <var>details</var> is
          present, then for each <var>item</var> in
          <var>details</var>.<a>displayItems</a>:
            <ol>
              <li data-tests=
              "payment-request-ctor-currency-code-checks.https.html">
                <a>Check and canonicalize amount</a>
                <var>item</var>.<a data-lt="PaymentItem.amount">amount</a>.
                Rethrow any exceptions.
              </li>
            </ol>
          </li>
          <li>Let <var>selectedShippingOption</var> be null.
          </li>
          <li>Process shipping options:
            <ol>
              <li>Let <var>options</var> be an empty <code><a data-cite=
              "!WEBIDL#idl-sequence">sequence</a></code>&lt;<a>PaymentShippingOption</a>&gt;.
              </li>
              <li>If the <a>shippingOptions</a> member of <var>details</var> is
              present, then:
                <ol data-link-for="PaymentShippingOption">
                  <li>Let <var>seenIDs</var> be an empty list.
                  </li>
                  <li>Set <var>options</var> to
                  <var>details</var>.<a data-link-for=
                  "PaymentDetailsBase">shippingOptions</a>.
                  </li>
                  <li>For each <var>option</var> in <var>options</var>:
                    <ol>
                      <li data-tests=
                      "payment-request-ctor-currency-code-checks.https.html">
                        <a>Check and canonicalize amount</a>
                        <var>item</var>.<a data-lt=
                        "PaymentItem.amount">amount</a>. Rethrow any
                        exceptions.
                      </li>
                      <li>If <var>seenIDs</var> contains
                      <var>option</var>.<a>id</a>, then throw a
                      <a>TypeError</a>. Optionally, inform the developer that
                      shipping option IDs must be unique.
                      </li>
                      <li>Otherwise, append <var>option</var>.<a>id</a> to
                      <var>seenIDs</var>.
                      </li>
                    </ol>
                  </li>
                  <li>For each <var>option</var> in <var>options</var>:
                    <ol>
                      <li>If <var>option</var>.<a>selected</a> is true, then
                      set <var>selectedShippingOption</var> to
                      <var>option</var>.<a>id</a>.
                      </li>
                    </ol>
                  </li>
                </ol>
              </li>
              <li>Set <var>details</var>.<a data-lt=
              "PaymentDetailsBase.shippingOptions">shippingOptions</a> to <var>
                options</var>.
              </li>
            </ol>
          </li>
          <li>Let <var>serializedModifierData</var> be an empty list.
          </li>
          <li data-link-for="PaymentDetailsBase">Process payment details
          modifiers:
            <ol>
              <li>Let <var>modifiers</var> be an empty <code><a data-cite=
              "!WEBIDL#idl-sequence">sequence</a></code>&lt;<a>PaymentDetailsModifier</a>&gt;.
              </li>
              <li>If the <a>modifiers</a> member of <var>details</var> is
              present, then:
                <ol>
                  <li>Set <var>modifiers</var> to
                  <var>details</var>.<a>modifiers</a>.
                  </li>
                  <li>For each <var>modifier</var> of <var>modifiers</var>:
                    <ol>
                      <li>If the <a data-lt=
                      "PaymentDetailsModifier.total">total</a> member of <var>
                        modifier</var> is present, then:
                        <ol>
                          <li data-tests=
                          "payment-request-ctor-currency-code-checks.https.html">
                            <a>Check and canonicalize total</a>
                            <var>modifier</var>.<a data-lt=
                            "PaymentDetailsModifier.total">total</a>.<a data-lt="PaymentItem.amount">amount</a>.
                            Rethrow any exceptions.
                          </li>
                        </ol>
                      </li>
                      <li>If the <a data-lt=
                      "PaymentDetailsModifier.additionalDisplayItems">additionalDisplayItems</a>
                      member of <var>modifier</var> is present, then for each
                      <var>item</var> of <var>modifier</var>.<a data-lt=
                      "PaymentDetailsModifier.additionalDisplayItems">additionalDisplayItems</a>:
                        <ol>
                          <li data-tests=
                          "payment-request-ctor-currency-code-checks.https.html">
                            <a>Check and canonicalize amount</a>
                            <var>item</var>.<a data-lt=
                            "PaymentItem.amount">amount</a>. Rethrow any
                            exceptions.
                          </li>
                        </ol>
                      </li>
                      <li>If the <a data-lt=
                      "PaymentDetailsModifier.data">data</a> member of
                      <var>modifier</var> is missing, let
                      <var>serializedData</var> be null. Otherwise, let
                      <var>serializedData</var> be the result of
                      <a>JSON-serializing</a> <var>modifier</var>.<a data-lt=
                      "PaymentDetailsModifier.data">data</a> into a string.
                      Rethrow any exceptions.
                      </li>
                      <li>Add <var>serializedData</var> to
                      <var>serializedModifierData</var>.
                      </li>
                      <li>Remove the <a data-lt="PaymentDetailsModifier.data">
                        data</a> member of <var>modifier</var>, if it is
                        present.
                      </li>
                    </ol>
                  </li>
                </ol>
              </li>
              <li>Set <var>details</var>.<a data-lt=
              "PaymentDetailsBase.modifiers">modifiers</a> to
              <var>modifiers</var>.
              </li>
            </ol>
          </li>
          <li>Let <var>request</var> be a new <a>PaymentRequest</a>.
          </li>
          <li>Set <var>request</var>.<a>[[\options]]</a> to <var>options</var>.
          </li>
          <li>Set <var>request</var>.<a>[[\state]]</a> to "<a>created</a>".
          </li>
          <li>Set <var>request</var>.<a>[[\updating]]</a> to false.
          </li>
          <li>Set <var>request</var>.<a>[[\details]]</a> to <var>details</var>.
          </li>
          <li>Set <var>request</var>.<a>[[\serializedModifierData]]</a> to
          <var>serializedModifierData</var>.
          </li>
          <li>Set <var>request</var>.<a>[[\serializedMethodData]]</a> to <var>
            serializedMethodData</var>.
          </li>
          <li>Set the value of <var>request</var>'s <a data-lt=
          "PaymentRequest.shippingOption">shippingOption</a> attribute to <var>
            selectedShippingOption</var>.
          </li>
          <li>Set the value of the <a data-lt="PaymentRequest.shippingAddress">
            shippingAddress</a> attribute on <var>request</var> to null.
          </li>
          <li>If <var>options</var>.<a data-lt=
          "PaymentOptions.requestShipping">requestShipping</a> is set to true,
          then set the value of the <a data-lt=
          "PaymentRequest.shippingType">shippingType</a> attribute on
          <var>request</var> to <var>options</var>.<a data-lt=
          "PaymentOptions.shippingType">shippingType</a>. Otherwise, set it to
          null.
          </li>
          <li>Return <var>request</var>.
          </li>
        </ol>
      </section>
      <section data-dfn-for="PaymentRequest" data-link-for="PaymentRequest">
        <h2>
          <dfn>id</dfn> attribute
        </h2>
        <p data-tests="payment-request-id-attribute.https.html">
          When getting, the <a>id</a> attribute returns this
          <a>PaymentRequest</a>'s <a>[[\details]]</a>.<a data-lt=
          "PaymentDetailsInit.id">id</a>.
        </p>
      </section>
      <section data-dfn-for="PaymentRequest" data-link-for="PaymentRequest">
        <h2>
          <dfn>show()</dfn> method
        </h2>
        <div class="note">
          <p>
            The <a>show()</a> method is called when a developer wants to begin
            user interaction for the payment request. The <a>show()</a> method
            returns a <a>Promise</a> that will be resolved when the <a>user
            accepts the payment request</a>. Some kind of user interface will
            be presented to the user to facilitate the payment request after
            the <a>show()</a> method returns.
          </p>
          <p>
            It is not possible to show multiple <a>PaymentRequest</a>s at the
            same time within one <a>user agent</a>. If a <a>PaymentRequest</a>
            is already showing, calling <a>show()</a> â€”from any Web siteâ€” will
            return a promise rejected with an "<a>AbortError</a>"
            <a>DOMException</a>.
          </p>
        </div>
        <p data-tests="payment-request-show-method.https.html">
          The <a>show()</a> method MUST act as follows:
        </p>
        <ol class="algorithm">
          <li>Let <var>request</var> be the <a>PaymentRequest</a> object on
          which the method is called.
          </li>
          <li>Let <var>document</var> be <var>request</var>'s <a data-cite=
          "!HTML#concept-relevant-global">relevant global object</a>'s
            <a href="!HTML#concept-document-window">associated Document</a>.
          </li>
          <li>If <var>document</var> is not <a data-cite="!HTML#fully-active">
            fully active</a>, then return a promise rejected with an
            "<a>AbortError</a>" <a>DOMException</a>.
          </li>
          <li>
            <p>
              Optionally, if the <a>user agent</a> wishes to disallow the call
              to <a>show()</a> to protect the user, then return a promise
              rejected with a "<a>SecurityError</a>" <a>DOMException</a>. For
              example, the <a>user agent</a> may require the call to be
              <a>triggered by user activation</a>, or may limit the rate at
              which a page can call <a>show()</a>, as described in the <a href=
              "#privacy">privacy considerations</a> section.
            </p>
            <p class="note">
              During the Candidate Recommendation phase, implementations are
              expected to experiment in this area. Developers using this API
              should investigate and anticipate such experiments and understand
              under what circumstances a "<a>SecurityError</a>"
              <a>DOMException</a> might occur. If interoperable behavior
              emerges amongst user agents, then that behavior will be
              standardized here before progressing the specification along the
              W3C Recommendation Track.
            </p>
          </li>
          <li>If <var>request</var>.<a>[[\state]]</a> is not "<a>created</a>"
          then return a promise rejected with an "<a>InvalidStateError</a>" <a>
            DOMException</a>.
          </li>
          <li>If the <a>user agent</a>'s <a>payment request is showing</a>
          boolean is true, then return a promise rejected with an
          "<a>AbortError</a>" <a>DOMException</a>.
          </li>
          <li>Set <var>request</var>.<a>[[\state]]</a> to "<a>interactive</a>".
          </li>
          <li>Let <var>acceptPromise</var> be a new <a>Promise</a>.
          </li>
          <li>Set <var>request</var>.<a>[[\acceptPromise]]</a> to
          <var>acceptPromise</var>.
          </li>
          <li>
            <p>
              Optionally:
            </p>
            <ol>
              <li>Reject <var>acceptPromise</var> with an "<a>AbortError</a>"
              <a>DOMException</a>.
              </li>
              <li>Set <var>request</var>.<a>[[\state]]</a> to "<a>closed</a>".
              </li>
              <li>Return <var>acceptPromise</var>.
              </li>
            </ol>
            <p class="note">
              This allows the <a>user agent</a> to act as if the user had
              immediately <a data-lt="user aborts the payment request">aborted
              the payment request</a>, at its discretion. For example, in
              "private browsing" modes or similar, user agents might take
              advantage of this step.
            </p>
          </li>
          <li>Set the <a>user agent</a>'s <a>payment request is showing</a>
          boolean to true.
          </li>
          <li>Return <var>acceptPromise</var> and perform the remaining steps
          <a>in parallel</a>.
          </li>
          <li>Let <var>handlers</var> be an empty unordered set.
          </li>
          <li>For each <var>paymentMethod</var> tuple in
          <var>request</var>.<a>[[\serializedMethodData]]</a>:
            <ol>
              <li>Let <var>identifier</var> be the first element in the
              <var>paymentMethod</var> tuple.
              </li>
              <li>Let <var>data</var> be the result of <a data-cite=
              "!ECMASCRIPT#sec-json.parse">JSON-parsing</a> the second element
              in the <var>paymentMethod</var> tuple.
              </li>
              <li>If required by the specification that defines the
              <var>identifer</var>, then <a data-cite=
              "!WEBIDL#dfn-convert-ecmascript-to-idl-value">convert</a>
              <var>data</var> to an IDL value. Otherwise, <a data-cite=
              "!WEBIDL#dfn-convert-ecmascript-to-idl-value">convert</a> to
              <a data-cite="!WEBIDL#idl-object">object</a>.
              </li>
              <li>If conversion results in an error, reject
              <var>acceptPromise</var> with that error and terminate this
              algorithm.
              </li>
              <li>If the user agent has a registered <a>payment handler</a>
              that supports <var>identifier</var>, then check if the payment
              handler is authorized and capable of handling the payment request
              with <var>data</var>. If the check returns in the affirmative,
              then add payment handler to <var>handlers</var>.
              </li>
            </ol>
          </li>
          <li>If <var>handlers</var> is empty, then reject
          <var>acceptPromise</var> with a "<a>NotSupportedError</a>"
          <a>DOMException</a>, and set the <a>user agent</a>'s <a>payment
          request is showing</a> boolean to false.
          </li>
          <li>
            <p>
              Otherwise, present a user interface to allow the user to interact
              with the <var>handlers</var>. The user agent SHOULD prioritize
              the preference of the user when presenting payment methods.
            </p>
            <p>
              For the <a>payment handler</a> selected by the end-user, the user
              agent MUST pass the <a data-cite=
              "!WEBIDL#dfn-convert-ecmascript-to-idl-value">converted</a>
              second element in the <var>paymentMethod</var> tuple. Optionally,
              the user agent SHOULD send the appropriate data from
              <var>request</var> to the user-selected <a>payment handler</a> in
              order to guide the user through the payment process. This
              includes the various attributes and internal slots of
              <var>request</var> (some MAY be excluded for privacy reasons
              where appropriate).
            </p>
            <p>
              The <var>acceptPromise</var> will later be resolved or rejected
              by either the <a>user accepts the payment request algorithm</a>
              or the <a>user aborts the payment request algorithm</a>, which
              are triggered through interaction with the user interface.
            </p>
            <p>
              If <var>document</var> stops being <a data-cite=
              "!HTML#fully-active">fully active</a> while the user interface is
              being shown, or no longer is by the time this step is reached,
              then the user interface SHOULD be hidden, and
              <var>acceptPromise</var> SHOULD be rejected with an
              "<a>AbortError</a>" <a>DOMException</a>.
            </p>
          </li>
        </ol>
      </section>
      <section data-dfn-for="PaymentRequest" data-link-for="PaymentRequest">
        <h2>
          <dfn>abort()</dfn> method
        </h2>
        <div class="note">
          <p>
            The <a>abort()</a> method is called if a developer wishes to tell
            the <a>user agent</a> to abort the payment <var>request</var> and
            to tear down any user interface that might be shown. The
            <a>abort()</a> can only be called after the <a>show()</a> method
            has been called (see <a data-lt="state">states</a>) and before this
            instance's <a>[[\acceptPromise]]</a> has been resolved. For
            example, developers might choose to do this if the goods they are
            selling are only available for a limited amount of time. If the
            user does not accept the payment request within the allowed time
            period, then the request will be aborted.
          </p>
          <p>
            A <a>user agent</a> might not always be able to abort a request.
            For example, if the <a>user agent</a> has delegated responsibility
            for the request to another app. In this situation, <a>abort()</a>
            will reject the returned <a>Promise</a>.
          </p>
          <p>
            See also the algorithm when the <a>user aborts the payment
            request</a>.
          </p>
        </div>
        <p data-tests="payment-request-abort-method.https.html">
          The <a>abort()</a> method MUST act as follows:
        </p>
        <ol class="algorithm">
          <li>Let <var>request</var> be the <a>PaymentRequest</a> object on
          which the method is called.
          </li>
          <li>If the value of <var>request</var>.<a>[[\state]]</a> is not
          "<a>interactive</a>" then <a>throw</a> an "<a>InvalidStateError</a>"
          <a>DOMException</a>.
          </li>
          <li>Let <var>promise</var> be a new <a>Promise</a>.
          </li>
          <li>Return <var>promise</var> and perform the remaining steps <a>in
          parallel</a>.
          </li>
          <li>Try to abort the current user interaction and close down any
          remaining user interface.
          </li>
          <li>
            <a>Queue a task</a> on the <a>user interaction task source</a> to
            perform the following steps:
            <ol>
              <li>If it is not possible to abort the current user interaction,
              then reject <var>promise</var> with "<a>InvalidStateError</a>"
              <a>DOMException</a> and abort these steps.
              </li>
              <li>Set the value of the internal slot
              <var>request</var>.<a>[[\state]]</a> to "<a>closed</a>".
              </li>
              <li>Reject the promise
              <var>request</var>.<a>[[\acceptPromise]]</a> with an
              "<a>AbortError</a>" <a>DOMException</a>.
              </li>
              <li>Resolve <var>promise</var> with undefined.
              </li>
            </ol>
          </li>
        </ol>
      </section>
      <section data-dfn-for="PaymentRequest" data-link-for="PaymentRequest">
        <h2>
          <dfn>canMakePayment()</dfn> method
        </h2>
        <p class="note">
          The <a>canMakePayment()</a> method can be used by the developer to
          determine if the <a>PaymentRequest</a> object can be used to make a
          payment, before they call <a>show()</a>. It returns a <a>Promise</a>
          that will be fulfilled with true if the <a>user agent</a> supports
          any of the desired <a>payment methods</a> supplied to the
          <a>PaymentRequest</a> constructor, and false if none are supported.
          If the method is called too often, the user agent might instead
          return a promise rejected with a "<a>NotAllowedError</a>"
          <a>DOMException</a>, at its discretion.
        </p>
        <p data-tests="payment-request-canmakepayment-method.https.html">
          The <a>canMakePayment()</a> method MUST act as follows:
        </p>
        <ol class="algorithm">
          <li>Let <var>request</var> be the <a>PaymentRequest</a> object on
          which the method was called.
          </li>
          <li>If <var>request</var>.<a>[[\state]]</a> is not "<a>created</a>",
          then return a promise rejected with an "<a>InvalidStateError</a>" <a>
            DOMException</a>.
          </li>
          <li>Optionally, at the <a>user agent</a>'s discretion, return a
          promise rejected with a "<a>NotAllowedError</a>" <a>DOMException</a>.
            <p class="note" data-link-for="PaymentRequest">
              This allows user agents to apply heuristics to detect and prevent
              abuse of the <a>canMakePayment()</a> method for fingerprinting
              purposes, such as creating <a>PaymentRequest</a> objects with a
              variety of supported <a>payment methods</a> and calling
              <a>canMakePayment()</a> on them one after the other. For example,
              a user agent may restrict the number of successful calls that can
              be made based on the <a>top-level browsing context</a> or the
              time period in which those calls were made.
            </p>
          </li>
          <li>Let <var>promise</var> be a new <a>Promise</a>.
          </li>
          <li>Return <var>promise</var>, and perform the remaining steps <a>in
          parallel</a>.
          </li>
          <li>For each <var>methodData</var> in
          <var>request</var>.<a>[[\serializedMethodData]]</a>:
            <ol>
              <li>If <var>methodData</var>.<a data-lt=
              "PaymentMethodData.supportedMethods">supportedMethods</a> is a
              supported <a>payment method identifier</a> (including its
              <a>payment method</a> specific capabilities), resolve
              <var>promise</var> with true, and abort this algorithm.
              </li>
            </ol>
          </li>
          <li>Resolve <var>promise</var> with false.
          </li>
        </ol>
      </section>
      <section data-dfn-for="PaymentRequest" data-link-for="PaymentRequest">
        <h2>
          <dfn>shippingAddress</dfn> attribute
        </h2>
        <p>
          A <a>PaymentRequest</a>'s <a>shippingAddress</a> attribute is
          populated when the user provides a shipping address. It is null by
          default. When a user provides a shipping address, the <a>shipping
          address changed algorithm</a> runs.
        </p>
      </section>
      <section data-dfn-for="PaymentRequest" data-link-for="PaymentRequest">
        <h2>
          <dfn>shippingType</dfn> attribute
        </h2>
        <p data-tests="payment-request-shippingType-attribute.https.html">
          A <a>PaymentRequest</a>'s <a>shippingType</a> attribute is the type
          of shipping used to fulfill the transaction. Its value is either a
          <a>PaymentShippingType</a> enum value, or null if none is provided by
          the developer during <a data-lt=
          "PaymentRequest.PaymentRequest()">construction</a> (see
          <a>PaymentOptions</a>'s <a data-lt=
          "PaymentOptions.shippingType">shippingType</a> member).
        </p>
      </section>
      <section data-dfn-for="PaymentRequest" data-link-for="PaymentRequest">
        <h2>
          <dfn>onshippingaddresschange</dfn> attribute
        </h2>
        <p data-tests=
        "payment-request-onshippingaddresschange-attribute.https.html">
          A <a>PaymentRequest</a>'s <a>onshippingaddresschange</a> attribute is
          an <a>EventHandler</a> for a <a>PaymentRequestUpdateEvent</a> named
          <a>shippingaddresschange</a>.
        </p>
      </section>
      <section data-dfn-for="PaymentRequest" data-link-for="PaymentRequest">
        <h2>
          <dfn>shippingOption</dfn> attribute
        </h2>
        <p data-tests="payment-request-shippingOption-attribute.https.html">
          A <a>PaymentRequest</a>'s <a>shippingOption</a> attribute is
          populated when the user chooses a shipping option. It is null by
          default. When a user chooses a shipping option, the <a>shipping
          option changed algorithm</a> runs.
        </p>
      </section>
      <section data-dfn-for="PaymentRequest" data-link-for="PaymentRequest">
        <h2>
          <dfn>onshippingoptionchange</dfn> attribute
        </h2>
        <p data-tests=
        "payment-request-onshippingoptionchange-attribute.https.html">
          A <a>PaymentRequest</a>'s <a>onshippingoptionchange</a> attribute is
          an <a>EventHandler</a> for a <a>PaymentRequestUpdateEvent</a> named
          <a>shippingoptionchange</a>.
        </p>
      </section>
      <section>
        <h2>
          Internal Slots
        </h2>
        <p>
          Instances of <a>PaymentRequest</a> are created with the internal
          slots in the following table:
        </p>
        <table>
          <tr>
            <th>
              Internal Slot
            </th>
            <th>
              Description (<em>non-normative</em>)
            </th>
          </tr>
          <tr>
            <td>
              <dfn>[[\serializedMethodData]]</dfn>
            </td>
            <td>
              The <code>methodData</code> supplied to the constructor, but
              represented as tuples containing supported methods and a string
              or null for data (instead of the original object form).
            </td>
          </tr>
          <tr>
            <td>
              <dfn>[[\serializedModifierData]]</dfn>
            </td>
            <td>
              A list containing the serialized string form of each <a data-lt=
              "PaymentDetailsModifier.data">data</a> member for each
              corresponding item in the sequence
              <a>[[\details]]</a>.<a data-lt="PaymentDetailsBase">modifier</a>,
              or null if no such member was present.
            </td>
          </tr>
          <tr>
            <td>
              <dfn>[[\details]]</dfn>
            </td>
            <td>
              The current <a>PaymentDetailsBase</a> for the payment request
              initially supplied to the constructor and then updated with calls
              to <a data-lt=
              "PaymentRequestUpdateEvent.updateWith">updateWith()</a>. Note
              that all <a data-lt="PaymentDetailsModifier.data">data</a>
              members of <a>PaymentDetailsModifier</a> instances contained in
              the <a data-lt="PaymentDetailsBase.modifiers">modifiers</a>
              member will be removed, as they are instead stored in serialized
              form in the <a>[[\serializedModifierData]]</a> internal slot.
            </td>
          </tr>
          <tr>
            <td>
              <dfn>[[\options]]</dfn>
            </td>
            <td>
              The <a>PaymentOptions</a> supplied to the constructor.
            </td>
          </tr>
          <tr>
            <td>
              <dfn>[[\state]]</dfn>
            </td>
            <td>
              <p>
                The current <dfn>state</dfn> of the payment request, which
                transitions from:
              </p>
              <dl>
                <dt>
                  "<dfn>created</dfn>"
                </dt>
                <dd>
                  The payment request is constructed and has not been presented
                  to the user.
                </dd>
                <dt>
                  "<dfn>interactive</dfn>"
                </dt>
                <dd>
                  The payment request is being presented to the user.
                </dd>
                <dt>
                  "<dfn>closed</dfn>"
                </dt>
                <dd>
                  The payment request completed.
                </dd>
              </dl>
              <p>
                The <a>state</a> transitions are illustrated in the figure
                below:
              </p>
              <figure>
                <img alt="" src="images/state-transitions.svg" width="518"
                height="125">
                <figcaption data-link-for="PaymentRequest">
                  The constructor sets the initial <a>state</a> to
                  "<a>created</a>". The <a>show()</a> method changes the
                  <a>state</a> to "<a>interactive</a>". From there, the
                  <a>abort()</a> method or any other error can send the
                  <a>state</a> to "<a>closed</a>"; similarly, the <a>user
                  accepts the payment request algorithm</a> and <a>user aborts
                  the payment request algorithm</a> will change the
                  <a>state</a> to "<a>closed</a>".
                </figcaption>
              </figure>
            </td>
          </tr>
          <tr>
            <td>
              <dfn>[[\updating]]</dfn>
            </td>
            <td>
              true is there is a pending <a data-lt=
              "PaymentRequestUpdateEvent.updateWith">updateWith()</a> call to
              update the payment request and false otherwise.
            </td>
          </tr>
          <tr>
            <td>
              <dfn>[[\acceptPromise]]</dfn>
            </td>
            <td>
              The pending <a>Promise</a> created during <a data-lt=
              "PaymentRequest.show">show</a> that will be resolved if the user
              accepts the payment request.
            </td>
          </tr>
        </table>
      </section>
    </section>
    <section data-dfn-for="PaymentMethodData" data-link-for=
    "PaymentMethodData">
      <h2>
        <dfn>PaymentMethodData</dfn> dictionary
      </h2>
      <pre class="idl">
        dictionary PaymentMethodData {
          required DOMString supportedMethods;
          object data;
        };
      </pre>
      <p>
        A <a>PaymentMethodData</a> dictionary is used to indicate a set of
        supported <a>payment methods</a> and any associated <a>payment
        method</a> specific data for those methods.
      </p>
      <dl>
        <dt>
          <dfn>supportedMethods</dfn> member
        </dt>
        <dd>
          A <a>payment method identifier</a> for a <a>payment method</a> that
          the merchant web site accepts.
        </dd>
        <dt>
          <dfn>data</dfn> member
        </dt>
        <dd>
          An object that provides optional information that might be needed by
          the supported payment methods. If supplied, it will be
          <a>JSON-serialized</a>.
        </dd>
      </dl>
      <p class="note">
        The value of <code>supportedMethods</code> was changed from array to
        string, but the name was left as a plural to maintain compatibility
        with existing content on the Web.
      </p>
    </section>
    <section data-dfn-for="PaymentCurrencyAmount" data-link-for=
    "PaymentCurrencyAmount">
      <h2>
        <dfn>PaymentCurrencyAmount</dfn> dictionary
      </h2>
      <pre class="idl">
        dictionary PaymentCurrencyAmount {
          required DOMString currency;
          required DOMString value;
          // Note: currencySystem is "at risk" of being removed!
          DOMString currencySystem = "urn:iso:std:iso:4217";
        };
      </pre>
      <p>
        A <a>PaymentCurrencyAmount</a> dictionary is used to supply monetary
        amounts.
      </p>
      <div class="issue atrisk">
        <p>
          This feature has been marked "<a>at risk</a>". If you'd like for this
          feature to remain in the specification, please describe your use case
          in <a href="https://github.com/w3c/payment-request/issues/490">issue
          490</a>.
        </p>
        <dl>
          <dt>
            <dfn>currencySystem</dfn> member
          </dt>
          <dd>
            A URL that indicates the currency system that the <a>currency</a>
            identifier belongs to. By default, the value is
            "<code>urn:iso:std:iso:4217</code>" indicating that <a>currency</a>
            is defined by [[!ISO4217]] (for example, <code>USD</code> for US
            Dollars).
          </dd>
        </dl>
      </div>
      <dl>
        <dt>
          <dfn>currency</dfn> member
        </dt>
        <dd>
          <p>
            A string containing a currency identifier. The value of
            <a>currency</a> can be any string that is valid within the currency
            system indicated by <a>currencySystem</a>.
          </p>
          <p>
            When using [[!ISO4217]], all <a data-cite=
            "!ecma-402#sec-iswellformedcurrencycode">well-formed</a> 3-letter
            alphabetic codes are allowed (i.e., the numeric codes are not
            supported). Their canonical form is upper case. However, the set of
            combinations of currency code for which localized currency symbols
            are available is implementation dependent. Where a localized
            currency symbol is not available, a user agent SHOULD use U+00A4
            (Â¤) for formatting.
          </p>
        </dd>
        <dt>
          <dfn>value</dfn>
        </dt>
        <dd>
          A <a>valid decimal monetary value</a> containing a monetary amount.
        </dd>
      </dl>
      <p>
        The following example shows how to represent US$55.00.
      </p>
      <pre class="example js">
        {
          "currency": "USD",
          "value" : "55.00"
        }
      </pre>
      <section>
        <h3>
          Validity checkers
        </h3>
        <p>
          A <dfn data-cite="INFRA#javascript-string">JavaScript string</dfn> is
          a <dfn>valid decimal monetary value</dfn> if it consists of the
          following <dfn data-lt="code point" data-cite="INFRA#code-point">code
          points</dfn> in the given order: [[!INFRA]]
        </p>
        <ol>
          <li>Optionally, a single U+002D (-), to indicate that the amount is
          negative.
          </li>
          <li>One or more <a>code points</a> in the range U+0030 (0) to U+0039
          (9).
          </li>
          <li>Optionally, a single U+002E (.) followed by one or more <a>code
          points</a> in the range U+0030 (0) to U+0039 (9).
          </li>
        </ol>
        <div class="note">
          The following regular expression is an implementation of the above
          definition.
          <pre class="hljs">^-?[0-9]+(\.[0-9]+)?$</pre>
        </div>
        <p>
          To <dfn>check and canonicalize amount</dfn> given a
          <a>PaymentCurrencyAmount</a> <var>amount</var>, run the following
          steps:
        </p>
        <ol data-link-for="PaymentCurrencyAmount">
          <li>If <var>amount</var>.<a>currencySystem</a> is not
          "<code>urn:iso:std:iso:4217</code>", terminate this algorithm.
          </li>
          <li>Let <var>isValidCurrency</var> be the result of calling
          <a data-cite=
          "!ecma-402#sec-iswellformedcurrencycode">IsWellFormedCurrencyCode</a>
          abstract operation with <var>amount</var>.<a>currency</a> as the
          argument.
          </li>
          <li>If <var>isValidCurrency</var> is false, then throw a
          <a>RangeError</a> exception and terminate this algorithm, optionally
          informing the developer that the currency is invalid.
          </li>
          <li>If <var>amount</var>.<a>value</a> is not a <a>valid decimal
          monetary value</a>, throw a <a>TypeError</a>, optionally informing
          the developer that the currency is invalid.
          </li>
          <li>Set <var>amount</var>.<a>currency</a> to the result of
          <a data-cite="!INFRA#ascii-uppercase">ASCII uppercasing</a>
          <var>amount</var>.<a>currency</a>.
          </li>
        </ol>
        <p>
          To <dfn>check and canonicalize total</dfn> given a
          <a>PaymentCurrencyAmount</a> <var>total</var>, run the following
          steps:
        </p>
        <ol data-link-for="PaymentCurrencyAmount">
          <li>If <var>total</var>.<a>currencySystem</a> is not
          "<code>urn:iso:std:iso:4217</code>", terminate this algorithm.
          </li>
          <li>
            <a>Check and canonicalize amount</a> <var>amount</var>. Rethrow any
            exceptions.
          </li>
          <li>If the first <a>code point</a> of <var>value</var> is U+002D (-),
          then throw a <a>TypeError</a> optionally informing the developer that
          a total can't be a negative number.
          </li>
        </ol>
      </section>
    </section>
    <section>
      <h2>
        Payment details dictionaries
      </h2>
      <section data-dfn-for="PaymentDetailsBase" data-link-for=
      "PaymentDetailsBase">
        <h2>
          <dfn>PaymentDetailsBase</dfn> dictionary
        </h2>
        <pre class="idl">
        dictionary PaymentDetailsBase {
          sequence&lt;PaymentItem&gt; displayItems;
          sequence&lt;PaymentShippingOption&gt; shippingOptions;
          sequence&lt;PaymentDetailsModifier&gt; modifiers;
        };
        </pre>
        <dl>
          <dt>
            <dfn>displayItems</dfn> member
          </dt>
          <dd>
            A sequence of <a>PaymentItem</a> dictionaries contains line items
            for the payment request that the <a>user agent</a> MAY display. For
            example, it might include details of products or breakdown of tax
            and shipping. It is optional to provide this information.
            <aside class="note">
              It is the developer's responsibility to verify that the
              <a data-lt="PaymentDetailsInit.total">total</a> amount is the sum
              of these items.
            </aside>
          </dd>
          <dt>
            <dfn>shippingOptions</dfn> member
          </dt>
          <dd>
            <p>
              A sequence containing the different shipping options for the user
              to choose from.
            </p>
            <p>
              If an item in the sequence has the <a data-lt=
              "PaymentShippingOption.selected">selected</a> member set to true,
              then this is the shipping option that will be used by default and
              <a data-lt="PaymentRequest.shippingOption">shippingOption</a>
              will be set to the <a data-lt="PaymentShippingOption.id">id</a>
              of this option without running the <a>shipping option changed
              algorithm</a>. Authors SHOULD NOT set <a data-lt=
              "PaymentShippingOption.selected">selected</a> to true on more
              than one item. If more than one item in the sequence has
              <a data-lt="PaymentShippingOption.selected">selected</a> set to
              true, then the <a>user agent</a> selects the last one in the
              sequence.
            </p>
            <p>
              The <a>shippingOptions</a> member is only used if the
              <a>PaymentRequest</a> was constructed with <a>PaymentOptions</a>
              <a data-lt="PaymentOptions.requestShipping">requestShipping</a>
              set to true.
            </p>
            <aside class="note">
              If the sequence has an item with the <a data-lt=
              "PaymentShippingOption.selected">selected</a> member set to true,
              then authors are responsible for ensuring that the <a data-lt=
              "PaymentDetailsInit.total">total</a> member includes the cost of
              the shipping option. This is because no
              <a>shippingoptionchange</a> event will be fired for this option
              unless the user selects an alternative option first.
            </aside>
          </dd>
          <dt>
            <dfn>modifiers</dfn> member
          </dt>
          <dd>
            A sequence of <a>PaymentDetailsModifier</a> dictionaries that
            contains modifiers for particular payment method identifiers. For
            example, it allows you to adjust the total amount based on payment
            method.
          </dd>
        </dl>
      </section>
      <section data-dfn-for="PaymentDetailsInit" data-link-for=
      "PaymentDetailsInit">
        <h2>
          <dfn>PaymentDetailsInit</dfn> dictionary
        </h2>
        <pre class="idl">
          dictionary PaymentDetailsInit : PaymentDetailsBase {
            DOMString id;
            required PaymentItem total;
          };
        </pre>
        <aside class="note">
          The <a>PaymentDetailsInit</a> dictionary is used in the construction
          of the payment request.
        </aside>
        <p>
          In addition to the members inherited from the
          <a>PaymentDetailsBase</a> dictionary, the following members are part
          of the <a>PaymentDetailsInit</a> dictionary:
        </p>
        <dl>
          <dt>
            <dfn>id</dfn> member
          </dt>
          <dd>
            A free-form identifier for this payment request.
            <aside class="note">
              If an <a>id</a> member is not present, then the <a>user agent</a>
              will generate a unique identifier for the payment request during
              <a data-lt="PaymentRequest.PaymentRequest()">construction</a>.
            </aside>
          </dd>
          <dt>
            <dfn>total</dfn> member
          </dt>
          <dd>
            A <a>PaymentItem</a> containing a non-negative total amount for the
            payment request.
            <aside class="note">
              Algorithms in this specification that accept a
              <a>PaymentDetailsInit</a> dictionary will throw if the
              <a>total</a>.<a data-lt=
              "PaymentItem.amount">amount</a>.<a data-lt=
              "PaymentCurrencyAmount.value">value</a> is a negative number.
            </aside>
          </dd>
        </dl>
      </section>
      <section data-dfn-for="PaymentDetailsUpdate" data-link-for=
      "PaymentDetailsUpdate">
        <h2>
          <dfn>PaymentDetailsUpdate</dfn> dictionary
        </h2>
        <pre class="idl">
          dictionary PaymentDetailsUpdate : PaymentDetailsBase {
            DOMString error;
            PaymentItem total;
          };
        </pre>
        <p>
          The <a>PaymentDetailsUpdate</a> dictionary is used to update the
          payment request using <a data-lt=
          "PaymentRequestUpdateEvent.updateWith">updateWith()</a>.
        </p>
        <p>
          In addition to the members inherited from the
          <a>PaymentDetailsBase</a> dictionary, the following members are part
          of the <a>PaymentDetailsUpdate</a> dictionary:
        </p>
        <dl>
          <dt>
            <dfn>error</dfn> member
          </dt>
          <dd>
            A human-readable string. When the payment request is updated using
            <a data-lt="PaymentRequestUpdateEvent.updateWith">updateWith()</a>,
            the <a>PaymentDetailsUpdate</a> can contain a message in the
            <a>error</a> member that will be displayed to the user, if the
            <a>PaymentDetailsUpdate</a> indicates that there are no valid
            <a data-lt="PaymentDetailsBase.shippingOptions">shippingOptions</a>
            (and the <a>PaymentRequest</a> was constructed with the <a data-lt=
            "PaymentOptions.requestShipping">requestShipping</a> option set to
            true). This can be used to explain why goods cannot be shipped to
            the chosen shipping address, or any other reason why no shipping
            options are available.
          </dd>
          <dt>
            <dfn>total</dfn> member
          </dt>
          <dd>
            A <a>PaymentItem</a> contains the non-negative <a data-lt=
            "PaymentItem.amount">amount</a>.
            <p class="note">
              Algorithms in this specification that accept a
              <a>PaymentDetailsUpdate</a> dictionary will throw if the
              <a>total</a>.<a data-lt=
              "PaymentItem.amount">amount</a>.<a data-lt=
              "PaymentCurrencyAmount.value">value</a> is a negative number.
            </p>
          </dd>
        </dl>
      </section>
    </section>
    <section data-dfn-for="PaymentDetailsModifier" data-link-for=
    "PaymentDetailsModifier">
      <h2>
        <dfn>PaymentDetailsModifier</dfn> dictionary
      </h2>
      <pre class="idl">
        dictionary PaymentDetailsModifier {
          required DOMString supportedMethods;
          PaymentItem total;
          sequence&lt;PaymentItem&gt; additionalDisplayItems;
          object data;
        };
      </pre>
      <p>
        The <a>PaymentDetailsModifier</a> dictionary provides details that
        modify the <a>PaymentDetailsBase</a> based on a <a>payment method
        identifier</a>. It contains the following members:
      </p>
      <dl>
        <dt>
          <dfn>supportedMethods</dfn> member
        </dt>
        <dd>
          A <a>payment method identifier</a>. The members of the
          <a>PaymentDetailsModifier</a> only apply if the user select this
          <a>payment method</a>.
        </dd>
        <dt>
          <dfn>total</dfn> member
        </dt>
        <dd>
          A <a>PaymentItem</a> value that overrides the <a data-lt=
          "PaymentDetailsInit.total">total</a> member in the
          <a>PaymentDetailsInit</a> dictionary for the <a>payment method
          identifiers</a> of the <a>supportedMethods</a> member.
        </dd>
        <dt>
          <dfn>additionalDisplayItems</dfn> member
        </dt>
        <dd>
          A sequence of <a>PaymentItem</a> dictionaries provides additional
          display items that are appended to the <a data-lt=
          "PaymentDetailsBase.displayItems">displayItems</a> member in the
          <a>PaymentDetailsBase</a> dictionary for the <a>payment method
          identifiers</a> in the <a>supportedMethods</a> member. This member is
          commonly used to add a discount or surcharge line item indicating the
          reason for the different <a>total</a> amount for the selected
          <a>payment method</a> that the user agent MAY display.
          <p class="note">
            It is the developer's responsibility to verify that the
            <a>total</a> amount is the sum of the <a data-lt=
            "PaymentDetailsBase.displayItems">displayItems</a> and the
            <a>additionalDisplayItems</a>.
          </p>
        </dd>
        <dt>
          <dfn>data</dfn> member
        </dt>
        <dd>
          An object that provides optional information that might be needed by
          the supported payment methods.
        </dd>
      </dl>
    </section>
    <section data-dfn-for="PaymentShippingType">
      <h2>
        <dfn>PaymentShippingType</dfn> enum
      </h2>
      <pre class="idl">
        enum PaymentShippingType {
          "shipping",
          "delivery",
          "pickup"
        };
      </pre>
      <dl>
        <dt>
          "<dfn>shipping</dfn>"
        </dt>
        <dd>
          This is the default and refers to the address being collected as the
          destination for shipping.
        </dd>
        <dt>
          "<dfn>delivery</dfn>"
        </dt>
        <dd>
          This refers to the address being collected as being used for
          delivery. This is commonly faster than shipping. For example, it
          might be used for food delivery.
        </dd>
        <dt>
          "<dfn>pickup</dfn>"
        </dt>
        <dd>
          This refers to the address being collected as part of a service
          pickup. For example, this could be the address for laundry pickup.
        </dd>
      </dl>
    </section>
    <section data-dfn-for="PaymentOptions" data-link-for="PaymentOptions">
      <h2>
        <dfn>PaymentOptions</dfn> dictionary
      </h2>
      <pre class="idl">
        dictionary PaymentOptions {
          boolean requestPayerName = false;
          boolean requestPayerEmail = false;
          boolean requestPayerPhone = false;
          boolean requestShipping = false;
          PaymentShippingType shippingType = "shipping";
        };
      </pre>
      <p class="note">
        The <a>PaymentOptions</a> dictionary is passed to the
        <a>PaymentRequest</a> constructor and provides information about the
        options desired for the payment request.
      </p>
      <dl>
        <dt>
          <dfn>requestPayerName</dfn> member
        </dt>
        <dd>
          A boolean that indicates whether the <a>user agent</a> SHOULD collect
          and return the payer's name as part of the payment request. For
          example, this would be set to true to allow a merchant to make a
          booking in the payer's name.
        </dd>
        <dt>
          <dfn>requestPayerEmail</dfn> member
        </dt>
        <dd>
          A boolean that indicates whether the <a>user agent</a> SHOULD collect
          and return the payer's email address as part of the payment request.
          For example, this would be set to true to allow a merchant to email a
          receipt.
        </dd>
        <dt>
          <dfn>requestPayerPhone</dfn> member
        </dt>
        <dd>
          A boolean that indicates whether the <a>user agent</a> SHOULD collect
          and return the payer's phone number as part of the payment request.
          For example, this would be set to true to allow a merchant to phone a
          customer with a billing enquiry.
        </dd>
        <dt>
          <dfn>requestShipping</dfn> member
        </dt>
        <dd>
          A boolean that indicates whether the <a>user agent</a> SHOULD collect
          and return a shipping address as part of the payment request. For
          example, this would be set to true when physical goods need to be
          shipped by the merchant to the user. This would be set to false for
          an online-only electronic purchase transaction.
        </dd>
        <dt>
          <dfn>shippingType</dfn> member
        </dt>
        <dd>
          A <a>ShippingType</a> enum value. Some transactions require an
          address for delivery but the term "shipping" isn't appropriate. For
          example, "pizza delivery" not "pizza shipping" and "laundry pickup"
          not "laundry shipping". If <a>requestShipping</a> is set to true,
          then the <a>shippingType</a> member can influence the way the <a>user
          agent</a> presents the user interface for gathering the shipping
          address.
          <p>
            The <a>shippingType</a> member only affects the user interface for
            the payment request.
          </p>
        </dd>
      </dl>
    </section>
    <section data-dfn-for="PaymentItem" data-link-for="PaymentItem">
      <h2>
        <dfn>PaymentItem</dfn> dictionary
      </h2>
      <pre class="idl">
        dictionary PaymentItem {
          required DOMString label;
          required PaymentCurrencyAmount amount;
          boolean pending = false;
        };
      </pre>
      <p>
        A sequence of one or more <a>PaymentItem</a> dictionaries is included
        in the <a>PaymentDetailsBase</a> dictionary to indicate what the
        payment request is for and the value asked for.
      </p>
      <dl>
        <dt>
          <dfn>label</dfn> member
        </dt>
        <dd>
          A human-readable description of the item. The <a>user agent</a> may
          display this to the user.
        </dd>
        <dt>
          <dfn>amount</dfn> member
        </dt>
        <dd>
          A <a>PaymentCurrencyAmount</a> containing the monetary amount for the
          item.
        </dd>
        <dt>
          <dfn>pending</dfn> member
        </dt>
        <dd>
          A boolean. When set to true it means that the <a>amount</a> member is
          not final. This is commonly used to show items such as shipping or
          tax amounts that depend upon selection of shipping address or
          shipping option. <a>User agents</a> MAY indicate pending fields in
          the user interface for the payment request.
        </dd>
      </dl>
    </section>
    <section data-dfn-for="PaymentAddress">
      <h2>
        <dfn>PaymentAddress</dfn> interface
      </h2>
      <pre class="idl">
        [SecureContext]
        interface PaymentAddress {
          [Default] object toJSON();
          readonly attribute DOMString country;
          readonly attribute FrozenArray&lt;DOMString&gt; addressLine;
          readonly attribute DOMString region;
          readonly attribute DOMString city;
          readonly attribute DOMString dependentLocality;
          readonly attribute DOMString postalCode;
          readonly attribute DOMString sortingCode;
          readonly attribute DOMString languageCode;
          readonly attribute DOMString organization;
          readonly attribute DOMString recipient;
          readonly attribute DOMString phone;
        };
      </pre>
      <section>
        <h2>
          <dfn>toJSON()</dfn> method
        </h2>
        <p>
          When called, run [[!WEBIDL]]'s <a data-cite=
          "WEBIDL#default-tojson-operation">default toJSON operation</a>.
        </p>
      </section>
      <section>
        <h2>
          <dfn>country</dfn> attribute
        </h2>
        <p>
          This is the [[!CLDR]] (Common Locale Data Repository) region code.
          For example, US, GB, CN, or JP.
        </p>
      </section>
      <section>
        <h2>
          <dfn>addressLine</dfn> attribute
        </h2>
        <p>
          This is the most specific part of the address. It can include, for
          example, a street name, a house number, apartment number, a rural
          delivery route, descriptive instructions, or a post office box
          number.
        </p>
      </section>
      <section>
        <h2>
          <dfn>region</dfn> attribute
        </h2>
        <p>
          This is the top level administrative subdivision of the country. For
          example, this can be a state, a province, an oblast, or a prefecture.
        </p>
      </section>
      <section>
        <h2>
          <dfn>city</dfn> attribute
        </h2>
        <p>
          This is the city/town portion of the address.
        </p>
      </section>
      <section>
        <h2>
          <dfn>dependentLocality</dfn> attribute
        </h2>
        <p>
          This is the dependent locality or sublocality within a city. For
          example, used for neighborhoods, boroughs, districts, or UK dependent
          localities.
        </p>
      </section>
      <section>
        <h2>
          <dfn>postalCode</dfn> attribute
        </h2>
        <p>
          This is the postal code or ZIP code, also known as PIN code in India.
        </p>
      </section>
      <section>
        <h2>
          <dfn>sortingCode</dfn> attribute
        </h2>
        <p>
          This is the sorting code as used in, for example, France.
        </p>
      </section>
      <section>
        <h2>
          <dfn>languageCode</dfn> attribute
        </h2>
        <p>
          This is the [[!BCP47]] language code for the address. It's used to
          determine the field separators and the order of fields when
          formatting the address for display.
        </p>
      </section>
      <section>
        <h2>
          <dfn>organization</dfn> attribute
        </h2>
        <p>
          This is the organization, firm, company, or institution at this
          address.
        </p>
      </section>
      <section>
        <h2>
          <dfn>recipient</dfn> attribute
        </h2>
        <p>
          This is the name of the recipient or contact person. This member may,
          under certain circumstances, contain multiline information. For
          example, it might contain "care of" information.
        </p>
      </section>
      <section>
        <h2>
          <dfn>phone</dfn> attribute
        </h2>
        <p>
          This is the phone number of the recipient or contact person.
        </p>
      </section>
    </section>
    <section data-dfn-for="PaymentShippingOption">
      <h2>
        <dfn>PaymentShippingOption</dfn> dictionary
      </h2>
      <pre class="idl">
        dictionary PaymentShippingOption {
          required DOMString id;
          required DOMString label;
          required PaymentCurrencyAmount amount;
          boolean selected = false;
        };
      </pre>
      <p>
        The <a>PaymentShippingOption</a> dictionary has members describing a
        shipping option. Developers can provide the user with one or more
        shipping options by calling the <a data-lt=
        "PaymentRequestUpdateEvent.updateWith">updateWith()</a> method in
        response to a change event.
      </p>
      <dl>
        <dt>
          <dfn>id</dfn> member
        </dt>
        <dd>
          A string identifier used to reference this
          <a>PaymentShippingOption</a>. It MUST be unique for a given
          <a>PaymentRequest</a>.
        </dd>
        <dt>
          <dfn>label</dfn> member
        </dt>
        <dd>
          A human-readable string description of the item. The <a>user
          agent</a> SHOULD use this string to display the shipping option to
          the user.
        </dd>
        <dt>
          <dfn>amount</dfn> member
        </dt>
        <dd>
          A <a>PaymentCurrencyAmount</a> containing the monetary amount for the
          item.
        </dd>
        <dt>
          <dfn>selected</dfn> member
        </dt>
        <dd>
          A boolean. When true, it indicates that this is the default selected
          <a>PaymentShippingOption</a> in a sequence. <a>User agents</a> SHOULD
          display this option by default in the user interface.
        </dd>
      </dl>
    </section>
    <section data-dfn-for="PaymentComplete" data-link-for="PaymentComplete">
      <h2>
        <dfn>PaymentComplete</dfn> enum
      </h2>
      <pre class="idl">
        enum PaymentComplete {
          "fail",
          "success",
          "unknown"
        };
      </pre>
      <dl>
        <dt>
          "<dfn>fail</dfn>"
        </dt>
        <dd>
          Indicates that processing of the payment failed. The <a>user
          agent</a> MAY display UI indicating failure.
        </dd>
        <dt>
          "<dfn>success</dfn>"
        </dt>
        <dd>
          Indicates the payment was successfully processed. The <a>user
          agent</a> MAY display UI indicating success.
        </dd>
        <dt>
          "<dfn>unknown</dfn>"
        </dt>
        <dd>
          The developer did not indicate success or failure and the <a>user
          agent</a> SHOULD NOT display UI indicating success or failure.
        </dd>
      </dl>
    </section>
    <section data-dfn-for="PaymentResponse" data-link-for="PaymentResponse">
      <h2>
        <dfn>PaymentResponse</dfn> interface
      </h2>
      <pre class="idl">
        [SecureContext]
        interface PaymentResponse {
          [Default] object toJSON();

          readonly attribute DOMString requestId;
          readonly attribute DOMString methodName;
          readonly attribute object details;
          readonly attribute PaymentAddress? shippingAddress;
          readonly attribute DOMString? shippingOption;
          readonly attribute DOMString? payerName;
          readonly attribute DOMString? payerEmail;
          readonly attribute DOMString? payerPhone;

          Promise&lt;void&gt; complete(optional PaymentComplete result = "unknown");
        };
      </pre>
      <p class="note">
        A <a>PaymentResponse</a> is returned when a user has selected a payment
        method and approved a payment request.
      </p>
      <section>
        <h2>
          <dfn>toJSON()</dfn> method
        </h2>
        <p>
          When called, run [[!WEBIDL]]'s <a data-cite=
          "WEBIDL#default-tojson-operation">default toJSON operation</a>.
        </p>
      </section>
      <section>
        <h2>
          <dfn>methodName</dfn> attribute
        </h2>
        <p data-tests=
        "payment-response/methodName-attribute-manual.https.html">
          The <a>payment method identifier</a> for the <a>payment method</a>
          that the user selected to fulfill the transaction.
        </p>
      </section>
      <section>
        <h2>
          <dfn>details</dfn> attribute
        </h2>
        <p>
          An <a data-cite="!WEBIDL#idl-object">object</a> or <a data-cite=
          "!WEBIDL#idl-dictionary">dictionary</a> generated by a <a>payment
          method</a> that a merchant can use to process or validate a
          transaction (depending on the <a>payment method</a>).
        </p>
        <aside class="note">
          <p>
            Each <a data-cite=
            "payment-method-id#standardized-payment-method-identifiers">standardized
            payment method identifier</a>, such as <a data-cite=
            "payment-method-basic-card">Basic Card</a> ("basic-card"), defines
            its own unique <a data-cite="!WEBIDL#idl-dictionary">IDL
            dictionary</a> for use with the <a>details</a> attribute. The shape
            of this data (i.e., its members and their corresponding types and
            formats) differs depending on which standardized payment method
            identifier is selected by the end user.
          </p>
          <p>
            Similarly, a <a data-cite=
            "payment-method-id#dfn-url-based-payment-method-identifier">URL-based
            payment method identifier</a> defines the shape of <a>details</a>.
            However, as URL-based payment method identifiers are not
            standardized by the W3C, developers need to consult whoever
            controls the URL for the expected shape of the <a>details</a>
            object.
          </p>
        </aside>
      </section>
      <section>
        <h2>
          <dfn>shippingAddress</dfn> attribute
        </h2>
        <p class=
        "payment-response/shippingAddress-attribute-manual.https.html">
          If the <a data-lt=
          "PaymentOptions.requestShipping">requestShipping</a> member was set
          to true in the <a>PaymentOptions</a> passed to the
          <a>PaymentRequest</a> constructor, then <a data-lt=
          "PaymentRequest.shippingAddress">shippingAddress</a> will be the full
          and final shipping address chosen by the user.
        </p>
      </section>
      <section>
        <h2>
          <dfn>shippingOption</dfn> attribute
        </h2>
        <p data-tests=
        "payment-response/shippingOption-attribute-manual.https.html">
          If the <a data-lt=
          "PaymentOptions.requestShipping">requestShipping</a> member was set
          to true in the <a>PaymentOptions</a> passed to the
          <a>PaymentRequest</a> constructor, then <a data-lt=
          "PaymentRequest.shippingOption">shippingOption</a> will be the
          <a data-lt="PaymentShippingOption.id">id</a> attribute of the
          selected shipping option.
        </p>
      </section>
      <section>
        <h2>
          <dfn>payerName</dfn> attribute
        </h2>
        <p data-tests="payment-response/payerName-attribute-manual.https.html">
          If the <a data-lt=
          "PaymentOptions.requestPayerName">requestPayerName</a> member was set
          to true in the <a>PaymentOptions</a> passed to the
          <a>PaymentRequest</a> constructor, then <a data-lt=
          "PaymentResponse.payerName">payerName</a> will be the name provided
          by the user.
        </p>
      </section>
      <section>
        <h2>
          <dfn>payerEmail</dfn> attribute
        </h2>
        <p data-tests=
        "payment-response/payerEmail-attribute-manual.https.html">
          If the <a data-lt=
          "PaymentOptions.requestPayerEmail">requestPayerEmail</a> member was
          set to true in the <a>PaymentOptions</a> passed to the
          <a>PaymentRequest</a> constructor, then <a data-lt=
          "PaymentResponse.payerEmail">payerEmail</a> will be the email address
          chosen by the user.
        </p>
      </section>
      <section>
        <h2>
          <dfn>payerPhone</dfn> attribute
        </h2>
        <p data-tests=
        "payment-response/payerPhone-attribute-manual.https.html">
          If the <a data-lt=
          "PaymentOptions.requestPayerPhone">requestPayerPhone</a> member was
          set to true in the <a>PaymentOptions</a> passed to the
          <a>PaymentRequest</a> constructor, then <a data-lt=
          "PaymentResponse.payerPhone">payerPhone</a> will be the phone number
          chosen by the user.
        </p>
      </section>
      <section>
        <h2>
          <dfn>requestId</dfn> attribute
        </h2>
        <p data-tests="payment-response/requestId-attribute-manual.https.html">
          The corresponding payment request <a data-lt=
          "PaymentRequest.id">id</a> that spawned this payment response.
        </p>
      </section>
      <section data-dfn-for="PaymentResponse" data-link-for="PaymentResponse">
        <h2>
          <dfn data-lt="complete(result)">complete()</dfn> method
        </h2>
        <p class="note">
          The <a>complete()</a> method is called after the user has accepted
          the payment request and the <a>[[\acceptPromise]]</a> has been
          resolved. Calling the <a>complete()</a> method tells the <a>user
          agent</a> that the payment interaction is over (and SHOULD cause any
          remaining user interface to be closed).
        </p>
        <p>
          After the payment request has been accepted and the
          <a>PaymentResponse</a> returned to the caller but before the caller
          calls <a>complete()</a> the payment request user interface remains in
          a pending state. At this point the user interface ought not offer a
          cancel command because acceptance of the payment request has been
          returned. However, if something goes wrong and the developer never
          calls <a>complete()</a> then the user interface is blocked.
        </p>
        <p>
          For this reason, implementations MAY impose a timeout for developers
          to call <a>complete()</a>. If the timeout expires then the
          implementation will behave as if <a>complete()</a> was called with no
          arguments.
        </p>
        <p data-tests="payment-response/complete-method-manual.https.html">
          The <a>complete(result)</a> method MUST act as follows:
        </p>
        <ol class="algorithm">
          <li>Let <var>promise</var> be a new <a>Promise</a>.
          </li>
          <li>If the value of the internal slot <a>[[\completeCalled]]</a> is
          true, reject <var>promise</var> with an "<a>InvalidStateError</a>"
          <a>DOMException</a>.
          </li>
          <li>Otherwise, set the value of the internal slot
          <a>[[\completeCalled]]</a> to true.
          </li>
          <li>Return <var>promise</var> and perform the remaining steps <a>in
          parallel</a>.
          </li>
          <li>Close down any remaining user interface. The <a>user agent</a>
          MAY use the value <var>result</var> to influence the user experience.
          </li>
          <li>Resolve <var>promise</var> with undefined.
          </li>
        </ol>
      </section>
      <section>
        <h2>
          Internal Slots
        </h2>
        <p>
          Instances of <a>PaymentResponse</a> are created with the internal
          slots in the following table:
        </p>
        <table>
          <tr>
            <th>
              Internal Slot
            </th>
            <th>
              Description (<em>non-normative</em>)
            </th>
          </tr>
          <tr>
            <td>
              <dfn>[[\completeCalled]]</dfn>
            </td>
            <td>
              true if the <a data-lt="PaymentResponse.complete">complete</a>
              method has been called and false otherwise.
            </td>
          </tr>
        </table>
      </section>
    </section>
    <section class="informative">
      <h2>
        <code>PaymentRequest</code> and <code>iframe</code> elements
      </h2>
      <p>
        To indicate that a cross-origin <a>iframe</a> is allowed to invoke the
        payment request API, the <a>allowpaymentrequest</a> attribute can be
        specified on the <a>iframe</a> element.
      </p>
    </section>
    <section>
      <h2>
        Events
      </h2>
      <section class="informative">
        <h2>
          Summary
        </h2>
        <table>
          <tr>
            <th>
              Event name
            </th>
            <th>
              Interface
            </th>
            <th>
              Dispatched whenâ€¦
            </th>
          </tr>
          <tr>
            <td>
              <code><dfn>shippingaddresschange</dfn></code>
            </td>
            <td>
              <a>PaymentRequestUpdateEvent</a>
            </td>
            <td>
              The user provides a new shipping address.
            </td>
          </tr>
          <tr>
            <td>
              <code><dfn>shippingoptionchange</dfn></code>
            </td>
            <td>
              <a>PaymentRequestUpdateEvent</a>
            </td>
            <td>
              The user chooses a new shipping option.
            </td>
          </tr>
        </table>
      </section>
      <section data-dfn-for="PaymentRequestUpdateEvent" data-link-for=
      "PaymentRequestUpdateEvent">
        <h2>
          <dfn>PaymentRequestUpdateEvent</dfn> interface
        </h2>
        <pre class="idl">
          [Constructor(DOMString type, optional PaymentRequestUpdateEventInit eventInitDict),SecureContext]
          interface PaymentRequestUpdateEvent : Event {
            void updateWith(Promise&lt;PaymentDetailsUpdate&gt; detailsPromise);
          };
        </pre>
        <p>
          The <a>PaymentRequestUpdateEvent</a> enables developers to update the
          details of the payment request in response to a user interaction.
        </p>
        <p>
          The <a>PaymentRequestUpdateEvent</a> constructor MUST set the
          internal slot <a>[[\waitForUpdate]]</a> to false.
        </p>
        <section>
          <h2>
            <dfn data-lt="updateWith(detailsPromise)">updateWith()</dfn> method
          </h2>
          <aside class="note">
            <p>
              If a developer wants to update the payment request, then they
              need to call <a>updateWith()</a> and provide a
              <a>PaymentDetailsUpdate</a> dictionary, or a promise for one,
              containing changed values that the <a>user agent</a> presents to
              the user.
            </p>
            <p>
              To prevent the user interface from blocking (and to reflect
              changes made by the end-user through the UI), developers need to
              immediately call <a>updateWith()</a>. If they don't,
              <a>[[\updatedUI]]</a> becomes true and <a>updateWith()</a> will
              throw.
            </p>
            <pre class="example" title="how to use `updateWith()` correctly.">
              // âŒ Bad - this won't work!
              request.onshippingaddresschange = async ev =&gt; {
                // await goes to next tick, and updateWith() was not
                // called before that, so [[updatedUI]] gets set to true.
                const details = await getNewDetails(oldDetails);
                // ðŸ’¥ Too late, throws "InvalidStateError".
                ev.updateWith(details);
              };

              // âœ… Good - UI will wait.
              request.onshippingaddresschange = ev =&gt; {
                // Calling updateWith() with a promise is ok ðŸ‘
                const promiseForNewDetails = getNewDetails(oldDetails);
                ev.updateWith(promiseForNewDetails);
              };
            </pre>
            <p>
              Additionally, <a>[[\updatedUI]]</a> and <a>[[\waitForUpdate]]</a>
              together prevent reuse of <a>PaymentRequestUpdateEvent</a>.
            </p>
            <pre class="example" title="can only call `updateWith()` once">
              // âŒ Bad - calling updateWith() doesn't work!
              request.addEventListener("shippingaddresschange", ev =&gt; {
                ev.updateWith(details); // this is ok.
                // ðŸ’¥ [[waitForUpdate]] is true, throws an "InvalidStateError".
                ev.updateWith(otherDetails);
              });

              // âŒ Bad - this won't work either!
              request.addEventListener("shippingaddresschange", async ev =&gt; {
                const p = Promise.resolve({ ...details });
                ev.updateWith(p);
                await p;
                // ðŸ’¥ the update has now completed, so [[updatedUI]] gets set to
                // true; this throws "InvalidStateError"
                ev.updateWith({ ...newDetails });
              });
            </pre>
          </aside>
          <p>
            The <a>updateWith(detailsPromise)</a> method MUST act as follows:
          </p>
          <ol class="algorithm">
            <li>Let <var>event</var> be this <a>PaymentRequestUpdateEvent</a>
            instance.
            </li>
            <li>If <var>event</var>'s <a>isTrusted</a> attribute is false, then
            then <a>throw</a> a "<a>InvalidStateError</a>" <a>DOMException</a>.
            </li>
            <li>If <var>event</var>.<a>[[\updatedUI]]</a> is true, then
            <a>throw</a> an "<a>InvalidStateError</a>" <a>DOMException</a>.
            </li>
            <li>If <var>event</var>.<a>[[\waitForUpdate]]</a> is true, then <a>
              throw</a> an "<a>InvalidStateError</a>" <a>DOMException</a>.
            </li>
            <li>Let <var>request</var> be the value of <var>event</var>'s
            <code><a data-cite="DOM#dom-event-target">target</a></code>
            attribute.
            </li>
            <li>If <var>request</var>.<a>[[\state]]</a> is not
            "<a>interactive</a>", then <a>throw</a> an
            "<a>InvalidStateError</a>" <a>DOMException</a>.
            </li>
            <li>If <var>request</var>.<a>[[\updating]]</a> is true, then
            <a>throw</a> an "<a>InvalidStateError</a>" <a>DOMException</a>.
            </li>
            <li>Set <var>event</var>'s <a>stop propagation flag</a> and <a>stop
            immediate propagation flag</a>.
            </li>
            <li>Set <var>event</var>.<a>[[\waitForUpdate]]</a> to true.
            </li>
            <li>Set <var>request</var>.<a>[[\updating]]</a> to true.
            </li>
            <li>The <a>user agent</a> SHOULD disable the user interface that
            allows the user to accept the payment request. This is to ensure
            that the payment is not accepted until developers have made changes
            required by the change. Developers MUST settle the
            <var>detailsPromise</var> to indicate that the payment request is
            valid again.
            </li>
            <li>
              <p>
                Return from the method and perform the remaining steps <a>in
                parallel</a>.
              </p>
              <p>
                The remaining steps are conditional on the
                <var>detailsPromise</var> settling. If
                <var>detailsPromise</var> never settles then the payment
                request is blocked. Users SHOULD always be able to cancel a
                payment request. Implementations MAY choose to implement a
                timeout for pending updates if <var>detailsPromise</var>
                doesn't settle in a reasonable amount of time. If an
                implementation chooses to implement a timeout, they must
                execute the steps listed below in the "upon rejection" path.
                Such a timeout is a fatal error for the payment request.
              </p>
            </li>
            <li>
              <a>Upon rejection</a> of <var>detailsPromise</var>:
              <ol>
                <li>
                  <a>Abort the update</a> with an "<a>AbortError</a>"
                  <a>DOMException</a>.
                </li>
              </ol>
            </li>
            <li>
              <a>Upon fulfillment</a> of <var>detailsPromise</var> with value
              <var>value</var>:
              <ol data-link-for="PaymentDetailsBase">
                <li>Let <var>details</var> be the result of <a data-cite=
                "!WEBIDL#es-dictionary">converting</a> <var>value</var> to a
                <a>PaymentDetailsUpdate</a> dictionary. If this <a>throws</a>
                an exception, <a>abort the update</a> with the thrown
                exception.
                </li>
                <li>Let <var>serializedModifierData</var> be an empty list.
                </li>
                <li>Let <var>selectedShippingOption</var> be null.
                </li>
                <li>Let <var>shippingOptions</var> be an empty
                <code><a data-cite=
                "!WEBIDL#idl-sequence">sequence</a></code>&lt;<a>PaymentShippingOption</a>&gt;.
                </li>
                <li>Validate and canonicalize the details:
                  <ol>
                    <li data-link-for="PaymentDetailsUpdate">If the
                    <a>total</a> member of <var>details</var> is present, then:
                      <ol>
                        <li>
                          <a>Check and canonicalize total</a>
                          <var>details</var>.<a>total</a>.<a data-lt=
                          "PaymentItem.amount">amount</a>. If an exception is
                          thrown, then <a>abort the update</a> with that
                          exception.
                        </li>
                      </ol>
                    </li>
                    <li>If the <a>displayItems</a> member of <var>details</var>
                    is present, then for each <var>item</var> in
                    <var>details</var>.<a>displayItems</a>:
                      <ol>
                        <li>
                          <a>Check and canonicalize amount</a>
                          <var>item</var>.<a data-lt=
                          "PaymentItem.amount">amount</a>. If an exception is
                          thrown, then <a>abort the update</a> with that
                          exception.
                        </li>
                      </ol>
                    </li>
                    <li>If the <a>shippingOptions</a> member of
                    <var>details</var> is present, and
                    <var>request</var>.<a>[[\options]]</a>.<a data-lt=
                    "PaymentOptions.requestShipping">requestShipping</a> is
                    true, then:
                      <ol>
                        <li>Set <var>shippingOptions</var> to
                        <var>details</var>.<a>shippingOptions</a>.
                        </li>
                        <li>Let <var>seenIDs</var> be an empty list.
                        </li>
                        <li>For each <var>option</var> in
                        <var>shippingOptions</var>:
                          <ol>
                            <li>
                              <a>Check and canonicalize amount</a>
                              <var>option</var>.<a data-lt=
                              "PaymentShippingOption.amount">amount</a>. If an
                              exception is thrown, then <a>abort the update</a>
                              with that exception.
                            </li>
                            <li data-tests=
                            "PaymentRequestUpdateEvent/updateWith-duplicate-shipping-options-manual.https.html">
                            If <var>seenIDs</var> contains
                            <var>option</var>.<a data-lt=
                            "PaymentShippingOption.id">id</a>, then <a>abort
                            the update</a> with a <a>TypeError</a>.
                            </li>
                            <li>Otherwise, append
                              <var>option</var>.<a data-lt="PaymentShippingOption.id">id</a>
                              to <var>seenIDs</var>.
                            </li>
                          </ol>
                        </li>
                        <li>For each <var>option</var> in
                        <var>shippingOptions</var>:
                          <ol>
                            <li>If <var>option</var>.<a data-lt=
                            "PaymentShippingOption.selected">selected</a> is
                            true, then set <var>selectedShippingOption</var> to
                            <var>option</var>.<a data-lt=
                            "PaymentShippingOption.id">id</a>.
                            </li>
                          </ol>
                        </li>
                      </ol>
                    </li>
                    <li>If the <a>modifiers</a> member of <var>details</var> is
                    present, then:
                      <ol>
                        <li>Let <var>modifiers</var> be the sequence
                        <var>details</var>.<a>modifiers</a>.
                        </li>
                        <li>Let <var>serializedModifierData</var> be an empty
                        list.
                        </li>
                        <li>For each <a>PaymentDetailsModifier</a>
                        <var>modifier</var> in <var>modifiers</var>:
                          <ol data-link-for="PaymentDetailsModifier">
                            <li data-tests=
                            "updateWith-method-pmi-handling-manual.https.html">
                            Run the steps to <a data-cite=
                            "payment-method-id#dfn-validate-a-payment-method-identifier">
                              validate a payment method identifier</a> with
                              <var>modifier</var>.<a data-lt=
                              "PaymentDetailsModifier.supportedMethods">supportedMethods</a>.
                              If it returns false, then <a>abort the update</a>
                              with a <a>RangeError</a> exception. Optional,
                              inform the developer that the payment method
                              identifier is invalid.
                            </li>
                            <li>If the <a>total</a> member of
                            <var>modifier</var> is present, then:
                              <ol>
                                <li>
                                  <a>Check and canonicalize total</a>
                                  <var>modifier</var>.<a>total</a>.<a data-lt=
                                  "PaymentItem.amount">amount</a>. If an
                                  exception is thrown, then <a>abort the
                                  update</a> with that exception.
                                </li>
                              </ol>
                            </li>
                            <li>If the <a>additionalDisplayItems</a> member of
                            <var>modifier</var> is present, then for each
                            <a>PaymentItem</a> <var>item</var> in
                            <var>modifier</var>.<a>additionalDisplayItems</a>:
                              <ol>
                                <li>
                                  <a>Check and canonicalize amount</a>
                                  <var>item</var>.<a data-lt=
                                  "PaymentItem.amount">amount</a>. If an
                                  exception is thrown, then <a>abort the
                                  update</a> with that exception.
                                </li>
                              </ol>
                            </li>
                            <li>If the <a data-lt=
                            "PaymentDetailsModifier.data">data</a> member of
                            <var>modifier</var> is missing, let
                            <var>serializedData</var> be null. Otherwise, let
                            <var>serializedData</var> be the result of
                            <a>JSON-serializing</a>
                            <var>modifier</var>.<a data-lt=
                            "PaymentDetailsModifier.data">data</a> into a
                            string. If <a>JSON-serializing</a> throws an
                            exception, then <a>abort the update</a> with that
                            exception.
                            </li>
                            <li>Add <var>serializedData</var> to
                            <var>serializedModifierData</var>.
                            </li>
                            <li>Remove the <a data-lt=
                            "PaymentDetailsModifier.data">data</a> member of
                            <var>modifier</var>, if it is present.
                            </li>
                          </ol>
                        </li>
                      </ol>
                    </li>
                  </ol>
                </li>
                <li>Update the <a>PaymentRequest</a> using the new details:
                  <ol>
                    <li data-link-for="PaymentDetailsUpdate">If the
                    <a>total</a> member of <var>details</var> is present, then:
                      <ol>
                        <li>Set
                        <var>request</var>.<a>[[\details]]</a>.<a data-link-for="PaymentDetailsInit">total</a>
                          to <var>details</var>.<a>total</a>.
                        </li>
                      </ol>
                    </li>
                    <li>If the <a>displayItems</a> member of <var>details</var>
                    is present, then:
                      <ol>
                        <li>Set
                        <var>request</var>.<a>[[\details]]</a>.<a>displayItems</a>
                        to <var>details</var>.<a>displayItems</a>.
                        </li>
                      </ol>
                    </li>
                    <li>If the <a>shippingOptions</a> member of
                    <var>details</var> is present, and
                    <var>request</var>.<a>[[\options]]</a>.<a data-lt=
                    "PaymentOptions.requestShipping">requestShipping</a> is
                    true, then:
                      <ol>
                        <li>Set
                        <var>request</var>.<a>[[\details]]</a>.<a>shippingOptions</a>
                        to <var>shippingOptions</var>.
                        </li>
                        <li>Set the value of <var>request</var>'s <a data-lt=
                        "PaymentRequest.shippingOption">shippingOption</a>
                        attribute to <var>selectedShippingOption</var>.
                        </li>
                      </ol>
                    </li>
                    <li>If the <a>modifiers</a> member of <var>details</var> is
                    present, then:
                      <ol>
                        <li>Set
                        <var>request</var>.<a>[[\details]]</a>.<a>modifiers</a>
                        to <var>details</var>.<a>modifiers</a>.
                        </li>
                        <li>Set
                        <var>request</var>.<a>[[\serializedModifierData]]</a>
                        to <var>serializedModifierData</var>.
                        </li>
                      </ol>
                    </li>
                    <li>If <var>request</var>.<a>[[\options]]</a>.<a data-lt=
                    "PaymentOptions.requestShipping">requestShipping</a> is
                    true, and
                    <var>request</var>.<a>[[\details]]</a>.<a>shippingOptions</a>
                    is empty, then the developer has signified that there are
                    no valid shipping options for the currently-chosen shipping
                    address (given by <var>request</var>'s <a data-lt=
                    "PaymentRequest.shippingAddress">shippingAddress</a>). In
                    this case, the user agent SHOULD display an error
                    indicating this, and MAY indicate that the currently-chosen
                    shipping address is invalid in some way. The user agent
                    SHOULD use the <a data-lt=
                    "PaymentDetailsUpdate.error">error</a> member of
                    <var>details</var>, if it is present, to give more
                    information about why there are no valid shipping options
                    for that address.
                    </li>
                  </ol>
                </li>
              </ol>
            </li>
            <li>In either case, run the following steps, after either the upon
            rejection or upon fulfillment steps have concluded:
              <ol>
                <li>Set <var>event</var>.<a>[[\waitForUpdate]]</a> to false.
                </li>
                <li>Set <var>event</var>.<a>[[\updatedUI]]</a> to true.
                </li>
                <li>Set <var>request</var>.<a>[[\updating]]</a> to false.
                </li>
                <li>The <a>user agent</a> SHOULD update the user interface
                based on any changed values in <var>request</var>. The user
                agent SHOULD re-enable user interface elements that might have
                been disabled in the steps above if appropriate.
                </li>
              </ol>
            </li>
          </ol>
          <p>
            If any of the above steps say to <dfn>abort the update</dfn> with
            an exception <var>exception</var>, then:
          </p>
          <ol>
            <li>Abort the current user interaction and close down any remaining
            user interface.
            </li>
            <li>Set <var>request</var>.<a>[[\state]]</a> to "<a>closed</a>".
            </li>
            <li>Reject the promise <var>request</var>.<a>[[\acceptPromise]]</a>
            with <var>exception</var>.
            </li>
            <li>Abort the algorithm.
            </li>
          </ol>
          <div class="note">
            <p>
              <a data-lt="abort the update">Aborting the update</a> is
              performed when there is a fatal error updating the payment
              request, such as the supplied <var>detailsPromise</var>
              rejecting, or its fulfillment value containing invalid data. This
              would potentially leave the payment request in an inconsistent
              state since the developer hasn't successfully handled the change
              event. Consequently, the <a>PaymentRequest</a> moves to a
              "<a>closed</a>" state. The error is signaled to the developer
              through the rejection of the <a>[[\acceptPromise]]</a>, i.e., the
              promise returned by <a data-lt="PaymentRequest.show">show()</a>.
            </p>
            <p>
              <a>User agents</a> might show an error message to the user when
              this occurs.
            </p>
          </div>
        </section>
        <section>
          <h2>
            Internal Slots
          </h2>
          <p>
            Instances of <a>PaymentRequestUpdateEvent</a> are created with the
            internal slots in the following table:
          </p>
          <table>
            <tr>
              <th>
                Internal Slot
              </th>
              <th>
                Description (<em>non-normative</em>)
              </th>
            </tr>
            <tr>
              <td>
                <dfn>[[\waitForUpdate]]</dfn>
              </td>
              <td>
                A boolean indicating whether an <a>updateWith()</a>-initiated
                update is currently in progress.
              </td>
            </tr>
            <tr>
              <td>
                <dfn>[[\updatedUI]]</dfn>
              </td>
              <td>
                A boolean indicating whether the event performed an update.
              </td>
            </tr>
          </table>
        </section>
        <section>
          <h3>
            <dfn>PaymentRequestUpdateEventInit</dfn> dictionary
          </h3>
          <pre class="idl">
            dictionary PaymentRequestUpdateEventInit : EventInit {};
          </pre>
        </section>
      </section>
    </section>
    <section>
      <h2>
        Algorithms
      </h2>
      <p>
        When the internal slot <a>[[\state]]</a> of a <a>PaymentRequest</a>
        object is set to "<a>interactive</a>", the <a>user agent</a> will
        trigger the following algorithms based on user interaction.
      </p>
      <section>
        <h2>
          Shipping address changed algorithm
        </h2>
        <p data-tests=
        "algorithms-manual.https.html#shipping-address-changed-algo">
          The <dfn>shipping address changed algorithm</dfn> runs when the user
          provides a new shipping address. It MUST run the following steps:
        </p>
        <ol class="algorithm">
          <li>Let <var>request</var> be the <a>PaymentRequest</a> object that
          the user is interacting with.
          </li>
          <li>Let <var>name</var> be "<a>shippingaddresschange</a>".
          </li>
          <li>
            <a>Queue a task</a> on the <a>user interaction task source</a> to
            run the following steps:
            <ol>
              <li>Set the <a data-lt=
              "PaymentRequest.shippingAddress">shippingAddress</a> attribute on
              <var>request</var> to the shipping address provided by the user.
              </li>
              <li>Run the <a>PaymentRequest updated algorithm</a> with
              <var>request</var> and <var>name</var>.
              </li>
            </ol>
          </li>
        </ol>
      </section>
      <section>
        <h2>
          Shipping option changed algorithm
        </h2>
        <p data-tests=
        "algorithms-manual.https.html#shipping-option-changed-algo">
          The <dfn>shipping option changed algorithm</dfn> runs when the user
          chooses a new shipping option. It MUST run the following steps:
        </p>
        <ol class="algorithm">
          <li>Let <var>request</var> be the <a>PaymentRequest</a> object that
          the user is interacting with.
          </li>
          <li>Let <var>name</var> be "<a>shippingoptionchange</a>".
          </li>
          <li>
            <a>Queue a task</a> on the <a>user interaction task source</a> to
            run the following steps:
            <ol>
              <li>Set the <a data-lt=
              "PaymentRequest.shippingOption">shippingOption</a> attribute on
              <var>request</var> to the <code>id</code> string of the
              <a>PaymentShippingOption</a> provided by the user.
              </li>
              <li>Run the <a>PaymentRequest updated algorithm</a> with
              <var>request</var> and <var>name</var>.
              </li>
            </ol>
          </li>
        </ol>
      </section>
      <section>
        <h2>
          PaymentRequest updated algorithm
        </h2>
        <p data-tests="algorithms-manual.https.html">
          The <dfn>PaymentRequest updated algorithm</dfn> is run by other
          algorithms above to <a>fire an event</a> to indicate that a user has
          made a change to a <a>PaymentRequest</a> called <var>request</var>
          with an event name of <var>name</var>.
        </p>
        <p>
          It MUST run the following steps:
        </p>
        <ol class="algorithm">
          <li>If the <var>request</var>.<a>[[\updating]]</a> is true, then
          terminate this algorithm and take no further action. Only one update
          may take place at a time. The <a>user agent</a> SHOULD ensure that
          this never occurs.
          </li>
          <li>If the <var>request</var>.<a>[[\state]]</a> is not set to
          "<a>interactive</a>", then terminate this algorithm and take no
          further action. The <a>user agent</a> user interface SHOULD ensure
          that this never occurs.
          </li>
          <li>Let <var>event</var> be the result of <a data-cite=
          "!DOM#concept-event-create">creating an event</a> using
          <a>PaymentRequestUpdateEvent</a>.
          </li>
          <li>Initialize <var>event</var>'s <a data-cite="!DOM#dom-event-type">
            type</a> attribute to <var>name</var>.
          </li>
          <li>
            <a data-cite="!DOM#concept-event-dispatch">Dispatch</a>
            <var>event</var> at <var>request</var>.
          </li>
          <li data-link-for="PaymentRequestUpdateEvent">If
          <var>event</var>.<a>[[\waitForUpdate]]</a> is true, disable any part
          of the user interface that could cause another update event to be
          fired.
          </li>
          <li>Otherwise, set <var>event</var>.<a>[[\updatedUI]]</a> to true and
          update the user interface based on any changed values.
          </li>
        </ol>
      </section>
      <section>
        <h2>
          User accepts the payment request algorithm
        </h2>
        <p>
          The <dfn data-lt="user accepts the payment request">user accepts the
          payment request algorithm</dfn> runs when the user accepts the
          payment request and confirms that they want to pay. It MUST <a>queue
          a task</a> on the <a>user interaction task source</a> to perform the
          following steps:
        </p>
        <ol class="algorithm">
          <li>Let <var>request</var> be the <a>PaymentRequest</a> object that
          the user is interacting with.
          </li>
          <li>If the <var>request</var>.<a>[[\updating]]</a> is true, then
          terminate this algorithm and take no further action. The <a>user
          agent</a> user interface SHOULD ensure that this never occurs.
          </li>
          <li>If <var>request</var>.<a>[[\state]]</a> is not
          "<a>interactive</a>", then terminate this algorithm and take no
          further action. The <a>user agent</a> user interface SHOULD ensure
          that this never occurs.
          </li>
          <li>If the <a data-lt=
          "PaymentOptions.requestShipping">requestShipping</a> value of
          <var>request</var>.<a>[[\options]]</a> is true, then if the
          <a data-lt="PaymentRequest.shippingAddress">shippingAddress</a>
          attribute of <var>request</var> is null or if the <a data-lt=
          "PaymentRequest.shippingOption">shippingOption</a> attribute of <var>
            request</var> is null, then terminate this algorithm and take no
            further action. The <a>user agent</a> SHOULD ensure that this never
            occurs.
          </li>
          <li>Let <var>response</var> be a new <a>PaymentResponse</a>.
          </li>
          <li>Set the <a data-lt="PaymentResponse.requestId">requestId</a>
          attribute value of <var>response</var> to the value of
          <var>request</var>.<a>[[\details]]</a>.<a data-lt=
          "PaymentDetailsInit.id">id</a>.
          </li>
          <li>Set the <a data-lt="PaymentResponse.methodName">methodName</a>
          attribute value of <var>response</var> to the <a>payment method
          identifier</a> for the <a>payment method</a> that the user selected
          to accept the payment.
          </li>
          <li>Set the <a data-lt="PaymentResponse.details">details</a>
          attribute value of <var>response</var> to an object containing the
          <a>payment method</a> specific object that will be used by the
          merchant to process or validate the transaction. The format of this
          response will be defined for each <a>payment method</a>.
          </li>
          <li>If the <a data-lt=
          "PaymentOptions.requestShipping">requestShipping</a> value of
          <var>request</var>.<a>[[\options]]</a> is true, then set the
          <a data-lt="PaymentResponse.shippingAddress">shippingAddress</a>
          attribute of <var>response</var> to the value of the <a data-lt=
          "PaymentRequest.shippingAddress">shippingAddress</a> attribute of
          <var>request</var>. Otherwise, set it to null.
          </li>
          <li>If the <a data-lt=
          "PaymentOptions.requestShipping">requestShipping</a> value of
          <var>request</var>.<a>[[\options]]</a> is true, then set the
          <a data-lt="PaymentResponse.shippingOption">shippingOption</a>
          attribute of <var>response</var> to the value of the <a data-lt=
          "PaymentRequest.shippingOption">shippingOption</a> attribute of <var>
            request</var>. Otherwise, set it to null.
          </li>
          <li>If the <a data-lt=
          "PaymentOptions.requestPayerName">requestPayerName</a> value of <var>
            request</var>.<a>[[\options]]</a> is true, then set the <a data-lt=
            "PaymentResponse.payerName">payerName</a> attribute of
            <var>response</var> to the payer's name provided by the user, or to
            null if none was provided. Otherwise, set it to null.
          </li>
          <li>If the <a data-lt=
          "PaymentOptions.requestPayerEmail">requestPayerEmail</a> value of
          <var>request</var>.<a>[[\options]]</a> is true, then set the
          <a data-lt="PaymentResponse.payerEmail">payerEmail</a> attribute of
          <var>response</var> to the payer's email address provided by the
          user, or to null if none was provided. Otherwise, set it to null.
          </li>
          <li>If the <a data-lt=
          "PaymentOptions.requestPayerPhone">requestPayerPhone</a> value of
          <var>request</var>.<a>[[\options]]</a> is true, then set the
          <a data-lt="PaymentResponse.payerPhone">payerPhone</a> attribute of
          <var>response</var> to the payer's phone number provided by the user,
          or to null if none was provided. When setting the <a data-lt=
          "PaymentResponse.payerPhone">payerPhone</a> value, the user agent
          SHOULD format the phone number to adhere to [[!E.164]]. Otherwise,
          set it to null.
          </li>
          <li>Set <var>response</var>.<a>[[\completeCalled]]</a> to false.
          </li>
          <li>Set <var>request</var>.<a>[[\state]]</a> to "<a>closed</a>".
          </li>
          <li>Set the <a>user agent</a>'s <a>payment request is showing</a>
          boolean to false.
          </li>
          <li>Resolve the pending promise
          <var>request</var>.<a>[[\acceptPromise]]</a> with
          <var>response</var>.
          </li>
        </ol>
      </section>
      <section>
        <h2>
          User aborts the payment request algorithm
        </h2>
        <p data-tests="user-abort-algorithm-manual.https.html">
          The <dfn data-lt="user aborts the payment request">user aborts the
          payment request algorithm</dfn> runs when the user aborts the payment
          request through the currently interactive user interface. It MUST
          <a>queue a task</a> on the <a>user interaction task source</a> to
          perform the following steps:
        </p>
        <ol class="algorithm">
          <li>Let <var>request</var> be the <a>PaymentRequest</a> object that
          the user is interacting with.
          </li>
          <li>If the <var>request</var>.<a>[[\updating]]</a> is true, then
          terminate this algorithm and take no further action. The <a>user
          agent</a> user interface SHOULD ensure that this never occurs.
          </li>
          <li>If <var>request</var>.<a>[[\state]]</a> is not
          "<a>interactive</a>", then terminate this algorithm and take no
          further action. The <a>user agent</a> user interface SHOULD ensure
          that this never occurs.
          </li>
          <li>Set <var>request</var>.<a>[[\state]]</a> to "<a>closed</a>".
          </li>
          <li>Set the <a>user agent</a>'s <a>payment request is showing</a>
          boolean to false.
          </li>
          <li>Reject the promise <var>request</var>.<a>[[\acceptPromise]]</a>
          with an "<a>AbortError</a>" <a>DOMException</a>.
          </li>
        </ol>
      </section>
    </section>
    <section class="informative">
      <h2>
        Security Considerations
      </h2>
      <section class="informative">
        <h2>
          Encryption of data fields
        </h2>
        <p>
          The <a>PaymentRequest</a> API does not directly support encryption of
          data fields. Individual <a>payment methods</a> may choose to include
          support for encrypted data but it is not mandatory that all
          <a>payment methods</a> support this.
        </p>
      </section>
      <section>
        <h2>
          Payment Handler Matching
        </h2>
        <p data-link-for="PaymentRequest">
          For security reasons, a user agent can limit matching (in
          <a>show()</a> and <a>canMakePayment()</a>) to <a>payment handlers</a>
          from the same <a data-cite="rfc6454#section-3.2">origin</a> as a URL
          <a>payment method identifier</a>. User agents can also use
          information provided by a <a>payment method</a> owner to match
          <a>payment handlers</a> from other origins.
        </p>
      </section>
    </section>
    <section id="privacy">
      <h2>
        Privacy Considerations
      </h2>
      <section>
        <h2>
          Exposing user information
        </h2>
        <p>
          The <a>user agent</a> MUST NOT share information about the user with
          a developer (e.g., the shipping address) without user consent.
        </p>
      </section>
      <section>
        <h2>
          Exposing available payment methods
        </h2>
        <p>
          Developers might try to call the payment request API repeatedly with
          only one payment method identifier to try to determine what payment
          methods a <a>user agent</a> has installed. There are legitimate
          scenarios for calling repeatedly (for example, to control the flow of
          payment method selection). The fact that a successful match to a
          payment method causes a user interface to be displayed mitigates the
          disclosure risk. Implementations MAY require a user action to
          initiate a payment request or they MAY rate limit the calls to the
          API to prevent too many repeated calls.
        </p>
      </section>
    </section>
    <section id="dependencies">
      <h2>
        Dependencies
      </h2>
      <p>
        This specification relies on several other underlying specifications.
      </p>
      <dl>
        <dt>
          Payment Method Identifiers
        </dt>
        <dd>
          The term <dfn data-lt="payment method identifiers">payment method
          identifier</dfn> is defined by [[!payment-method-id]]. It's an unique
          identifier for a <a>payment method</a>.
        </dd>
        <dt>
          HTML
        </dt>
        <dd>
          The following are defined by [[!HTML]]: <code><dfn data-cite=
          "!HTML/webappapis.html#eventhandler">EventHandler</dfn></code>,
          <dfn data-cite="!HTML/webappapis.html#queue-a-task">queue a
          task</dfn>, <dfn data-cite=
          "!HTML/webappapis.html#user-interaction-task-source">user interaction
          task source</dfn>, <dfn data-cite=
          "!HTML/webappapis.html#top-level-browsing-context">top-level browsing
          context</dfn>, <dfn data-cite=
          "!HTML/webappapis.html#current-settings-object">current settings
          object</dfn>, <dfn data-cite=
          "!HTML/iframe-embed-object.html#allowed-to-use">allowed to use</dfn>,
          <dfn data-cite=
          "!HTML/interaction.html#triggered-by-user-activation">triggered by
          user activation</dfn>, <dfn data-cite=
          "!HTML/infrastructure.html#in-parallel">in parallel</dfn>, the
          <code><dfn data-cite=
          "!HTML/iframe-embed-object.html#the-iframe-element">iframe</dfn></code>
          element, and the <code><dfn data-cite=
          "!HTML/iframe-embed-object.html#attr-iframe-allowpaymentrequest">allowpaymentrequest</dfn></code>
          attribute.
        </dd>
        <dt>
          ECMAScript
        </dt>
        <dd>
          The terms <dfn data-cite=
          "!ECMASCRIPT#sec-promise-objects">Promise</dfn>, <dfn data-cite=
          "!ECMASCRIPT#sec-object-internal-methods-and-internal-slots">internal
          slot</dfn>, <code><dfn data-cite=
          "!ECMASCRIPT#sec-native-error-types-used-in-this-standard-rangeerror">
          RangeError</dfn></code>, <code><dfn data-cite=
          "!ECMASCRIPT#sec-native-error-types-used-in-this-standard-typeerror">TypeError</dfn></code>,
          and <code><dfn data-cite=
          "!ECMASCRIPT#sec-json.stringify">JSON.stringify</dfn></code> are
          defined by [[!ECMASCRIPT]].
          <p>
            The term <dfn data-lt=
            "JSON-serialized|JSON-serializing">JSON-serialize</dfn> applied to
            a given object means to run the algorithm specified by the original
            value of the <a>JSON.stringify</a> function on the supplied object,
            passing the supplied object as the sole argument, and return the
            resulting string. This can throw an exception.
          </p>
        </dd>
        <dt>
          Writing Promise-Using Specifications
        </dt>
        <dd>
          The terms <dfn data-cite="!PROMISES-GUIDE#upon-fulfillment">upon
          fulfillment</dfn> and <dfn data-cite=
          "!PROMISES-GUIDE#upon-rejection">upon rejection</dfn> are defined by
          [[!PROMISES-GUIDE]].
        </dd>
        <dt>
          DOM
        </dt>
        <dd>
          The <code><dfn data-cite="!DOM#event">Event</dfn></code> interface,
          The <code><dfn data-cite=
          "!DOM#dictdef-eventinit">EventInit</dfn></code> dictionary, and the
          terms <dfn data-cite="!DOM#concept-event-fire">fire an event</dfn>,
          <dfn data-cite="!DOM#dispatch-flag">dispatch flag</dfn>,
          <dfn data-cite="!DOM#stop-propagation-flag">stop propagation
          flag</dfn>, <code><dfn data-cite=
          "!DOM#dom-event-istrusted">isTrusted</dfn></code> attribute, and
          <dfn data-cite="!DOM#stop-immediate-propagation-flag">stop immediate
          propagation flag</dfn> are defined by [[!DOM]].
        </dd>
        <dt>
          Web IDL
        </dt>
        <dd>
          <p>
            When this specification says to <dfn data-cite="!WEBIDL#dfn-throw"
            data-lt="throws">throw</dfn> an error, the <a>user agent</a> must
            throw an error as described in [[!WEBIDL]]. When this occurs in a
            sub-algorithm, this results in termination of execution of the
            sub-algorithm and all ancestor algorithms until one is reached that
            explicitly describes procedures for catching exceptions.
          </p>
          <p>
            The algorithm for <dfn data-cite=
            "!WEBIDL#dfn-convert-idl-to-ecmascript-value" data-lt=
            "converting">converting an ECMAScript value to a dictionary</dfn>
            is defined by [[!WEBIDL]].
          </p>
          <p>
            <code><dfn data-cite=
            "!WEBIDL#dfn-DOMException">DOMException</dfn></code> and the
            following <a>DOMException</a> types from [[!WEBIDL]] are used:
            "<code><dfn data-cite=
            "!WEBIDL#aborterror">AbortError</dfn></code>",
            "<code><dfn data-cite=
            "!WEBIDL#invalidstateerror">InvalidStateError</dfn></code>",
            "<code><dfn data-cite=
            "!WEBIDL#notallowederror">NotAllowedError</dfn></code>",
            "<code><dfn data-cite=
            "!WEBIDL#notsupportederror">NotSupportedError</dfn></code>", and
            "<code><dfn data-cite=
            "!WEBIDL#securityerror">SecurityError</dfn></code>".
          </p>
        </dd>
      </dl>
    </section>
    <section id="conformance">
      <p>
        There is only one class of product that can claim conformance to this
        specification: a <dfn data-lt="user agents">user agent</dfn>.
      </p>
      <p class="note">
        Although this specification is primarily targeted at web browsers, it
        is feasible that other software could also implement this specification
        in a conforming manner.
      </p>
      <p>
        User agents MAY implement algorithms given in this specification in any
        way desired, so long as the end result is indistinguishable from the
        result that would be obtained by the specification's algorithms.
      </p>
      <p>
        User agents MAY impose implementation-specific limits on otherwise
        unconstrained inputs, e.g., to prevent denial of service attacks, to
        guard against running out of memory, or to work around
        platform-specific limitations. When an input exceeds
        implementation-specific limit, the user agent MUST throw, or, in the
        context of a promise, reject with, a <a>TypeError</a> optionally
        informing the developer of how a particular input exceeded an
        implementation-specific limit.
      </p>
    </section>
    <section id="idl-index" class="appendix"></section>
    <section class="appendix">
      <h2>
        Acknowledgements
      </h2>
      <p>
        This specification was derived from a report published previously by
        the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator
        Community Group</a>.
      </p>
    </section>
  </body>
</html>
